<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ReturnGuard ‚Ä¢ v1.0</title>
  <meta name="theme-color" content="#0a84ff" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cpath fill='%230a84ff' d='M32 4l22 8v16c0 13.3-8.9 25.3-22 28-13.1-2.7-22-14.7-22-28V12l22-8z'/%3E%3Cpath fill='%23fff' d='M28 38l-7-7 3.5-3.5L28 31l11.5-11.5L43 23 28 38z'/%3E%3C/svg%3E" />
  <!-- External libs (CDN) -->
  <script src="https://unpkg.com/tesseract.js@5/dist/tesseract.min.js"></script>
  <script src="https://unpkg.com/@zxing/library@0.20.0"></script>
  <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>

<script>try{document.documentElement.classList.add('js-ok');}catch{}</script>

<script>
// EARLY failsafe binder: makes the + button and chooser work even if the main script fails.
(function(){
  function whenReady(cb){ if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', cb); } else { cb(); } }
  function $(id){ return document.getElementById(id); }
  function showErrorBanner(msg){
    try{
      var bar = document.createElement('div');
      bar.style.position='fixed'; bar.style.left='0'; bar.style.right='0'; bar.style.bottom='0';
      bar.style.background='#3a171b'; bar.style.color='#ffb3ad'; bar.style.padding='8px 12px';
      bar.style.borderTop='1px solid #5a2a28'; bar.style.fontSize='12px'; bar.style.zIndex='99999';
      bar.textContent = msg; document.body.appendChild(bar);
    }catch{}
  }
  whenReady(function(){
    try{
      var chooser = $('chooser'), close = $('chooser_close');
      if(close){
        close.addEventListener('click', function(){ chooser.style.display='none'; });
      }
      // Make the rgv1-fab functional even if main scripts fail
      try{
        var fab = $('rgv1-fab');
        if (fab && chooser) {
          fab.addEventListener('click', function (e) {
            try { e.preventDefault(); } catch(_){}
            chooser.style.display = 'flex';
          }, { passive: false });
        }
      }catch(_){}

      // Harden chooser options so they work even if main script fails
      try{
        function __rg_showCard(cardId){
          var ids = ['card_cap','card_scan','card_manual'];
          for (var i=0;i<ids.length;i++){
            var el = $(ids[i]);
            if (el) el.style.display = (ids[i]===cardId) ? 'block' : 'none';
          }
          if (chooser) chooser.style.display = 'none';
        }
        var chooserOpts = document.querySelectorAll ? document.querySelectorAll('#chooser .opt') : null;
        if (chooserOpts && chooserOpts.length){
          for (var j=0;j<chooserOpts.length;j++){
            (function(opt){
              opt.addEventListener('click', function(){
                try{
                  var t = opt.getAttribute('data-open');
                  if (t==='cap')      __rg_showCard('card_cap');
                  else if (t==='scan') __rg_showCard('card_scan');
                  else if (t==='manual') __rg_showCard('card_manual');
                }catch(ex){ showErrorBanner('Chooser opt error: '+ex.message); }
              });
            })(chooserOpts[j]);
          }
        }
      }catch(ex){ showErrorBanner('Early chooser hardening error: '+ex.message); }

    }catch(ex){ showErrorBanner('Early bind error: ' + ex.message); }
  });
})();
</script>

<style id="rg-mobile-v1-styles">
/* Light theme (default) */
:root {
  --rg-bg: #f9f9f9;
  --rg-fg: #1d1d1f;
  --rg-fg-weak: #86868b;
  --rg-card: #ffffff;
  --rg-accent: #007aff;
  --rg-border: #d1d1d6;
  --rg-radius: 16px;
  --rg-shadow: 0 4px 12px rgba(0,0,0,.08);
  --rg-topbar-bg: linear-gradient(180deg, rgba(249,249,249,.9), rgba(249,249,249,.7));
  --rg-topbar-fg: #1d1d1f;
  --rg-topbar-border: #d1d1d6;
  --rg-topbar-btn-bg: rgba(0,0,0,.05);
  --rg-topbar-btn-border: rgba(0,0,0,.1);

  /* --- Mappings for old CSS --- */
  --bg: var(--rg-bg);
  --card: var(--rg-card);
  --ink: var(--rg-fg);
  --muted: var(--rg-fg-weak);
  --accent: var(--rg-accent);
  --danger: #ff3b30;
  --warn: #ff9500;
  --success: #34c759;
  --line: var(--rg-border);
  --shadow: var(--rg-shadow);
  --radius: 12px;
  --focus: #64d2ff;
}

/* Dark theme - based on system preference */
@media (prefers-color-scheme: dark) {
  :root:not(.theme-light) { /* Avoids applying if user forces light mode */
    --rg-bg: #000000;
    --rg-fg: #f5f5f7;
    --rg-fg-weak: #8e8e93;
    --rg-card: #1c1c1e;
    --rg-accent: #0a84ff;
    --rg-border: #38383a;
    --rg-shadow: 0 8px 24px rgba(0,0,0,.35);
    --danger: #ff453a;
    --warn: #ff9f0a;
    --success: #30d158;
    --rg-topbar-bg: linear-gradient(180deg, rgba(28,28,30,.85), rgba(28,28,30,.7));
    --rg-topbar-fg: #f5f5f7;
    --rg-topbar-border: #38383a;
    --rg-topbar-btn-bg: rgba(255,255,255,.08);
    --rg-topbar-btn-border: rgba(255,255,255,.15);
  }
}

/* Dark theme - based on manual toggle */
html.theme-dark {
    --rg-bg: #000000;
    --rg-fg: #f5f5f7;
    --rg-fg-weak: #8e8e93;
    --rg-card: #1c1c1e;
    --rg-accent: #0a84ff;
    --rg-border: #38383a;
    --rg-shadow: 0 8px 24px rgba(0,0,0,.35);
    --danger: #ff453a;
    --warn: #ff9f0a;
    --success: #30d158;
    --rg-topbar-bg: linear-gradient(180deg, rgba(28,28,30,.85), rgba(28,28,30,.7));
    --rg-topbar-fg: #f5f5f7;
    --rg-topbar-border: #38383a;
    --rg-topbar-btn-bg: rgba(255,255,255,.08);
    --rg-topbar-btn-border: rgba(255,255,255,.15);
}

/* Light theme - based on manual toggle */
html.theme-light {
  --rg-bg: #f9f9f9;
  --rg-fg: #1d1d1f;
  --rg-fg-weak: #86868b;
  --rg-card: #ffffff;
  --rg-accent: #007aff;
  --rg-border: #d1d1d6;
  --rg-shadow: 0 4px 12px rgba(0,0,0,.08);
  --danger: #ff3b30;
  --warn: #ff9500;
  --success: #34c759;
  --rg-topbar-bg: linear-gradient(180deg, rgba(249,249,249,.9), rgba(249,249,249,.7));
  --rg-topbar-fg: #1d1d1f;
  --rg-topbar-border: #d1d1d6;
  --rg-topbar-btn-bg: rgba(0,0,0,.05);
  --rg-topbar-btn-border: rgba(0,0,0,.1);
}

html,body{ margin:0; padding:0; background:var(--rg-bg); color:var(--rg-fg); -webkit-tap-highlight-color:transparent; }
body{ font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; font-size:16px; line-height:1.35; overflow-x:hidden; }
button,.btn,[role="button"],input[type="button"],input[type="submit"]{ min-height:48px; min-width:48px; font-size:16px; border-radius:14px; padding:12px 16px; border:1px solid var(--rg-border); background:var(--rg-card); color:var(--rg-fg); cursor: pointer; }
button.primary, .btn.primary {
  background: linear-gradient(180deg, #007bff, #0070e0);
  border-color: transparent;
  color: white;
  font-weight: 600;
}
html.theme-dark button.primary, html.theme-dark .btn.primary {
  background: linear-gradient(180deg, #0a84ff, #0073e6);
}
input,select,textarea{ font-size:16px; border-radius:12px; border:1px solid var(--rg-border); padding:10px 12px; background:var(--rg-card); color:var(--rg-fg); }
.rgv1-card{ background:var(--rg-card); border:1px solid var(--rg-border); border-radius:var(--rg-radius); box-shadow:var(--rg-shadow); padding:12px; }
.rgv1-grid{ display:grid; gap:12px; grid-template-columns:1fr; }
@media (min-width:768px){ .rgv1-grid.cols-2{grid-template-columns:repeat(2,1fr);} .rgv1-grid.cols-3{grid-template-columns:repeat(3,1fr);} }

.rgv1-topbar{
  position:sticky; top:0; z-index:1000;
  backdrop-filter:saturate(180%) blur(12px);
  background: var(--rg-topbar-bg);
  color: var(--rg-topbar-fg);
  padding:12px 16px; display:flex; align-items:center; gap:12px;
  border-bottom:1px solid var(--rg-topbar-border);
}
.rgv1-title{ font-weight:700; font-size:18px; letter-spacing:.2px; }
.rgv1-spacer{ flex:1; }
.rgv1-topbar .rgv1-btn{
  background: var(--rg-topbar-btn-bg);
  color: var(--rg-topbar-fg);
  border:1px solid var(--rg-topbar-btn-border);
}

.rgv1-bottombar{ position:fixed; left:0; right:0; bottom:12px; z-index:1000; display:flex; gap:10px; justify-content:center; pointer-events:none; }
.rgv1-bottombar .rgv1-btn{ pointer-events:all; background:var(--rg-card); border:1px solid var(--rg-border); padding:10px 14px; border-radius:14px; box-shadow:var(--rg-shadow); }

#rgv1-fab{
  position:fixed; right:16px; bottom:16px; z-index:1001;
  width:64px; height:64px; border-radius:50%;
  background: linear-gradient(165deg, #3478f6, #0062f5);
  color:#fff; font-size:32px; line-height:0;
  display:flex; align-items:center; justify-content:center;
  box-shadow:0 12px 28px rgba(0, 98, 245, .4);
  border:none;
}
html.theme-dark #rgv1-fab {
  background: linear-gradient(165deg, #3887fe, #0a7aff);
  box-shadow:0 12px 28px rgba(10, 132, 255, .45);
}
#rgv1-fab:active{ transform:translateY(1px) scale(.98); }
.rgv1-hidden{ display:none !important; }
@media (max-width:767px){ .grid,.columns,.row,.rows{ display:grid !important; grid-template-columns:1fr !important; gap:12px !important; } table{ display:block; overflow-x:auto; } }

/* JS-required overlay */
#js_required_overlay {
  position:fixed;
  inset:0;
  background:var(--rg-bg);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:14px;
  color:var(--rg-fg);
  z-index:99999;
  padding:24px;
  text-align:center
}
#js_required_overlay .box {
  max-width:720px;
  background:var(--rg-card);
  border:1px solid var(--rg-border);
  border-radius:16px;
  box-shadow:var(--rg-shadow);
  padding:18px
}
#js_required_overlay h2 {
  margin:0 0 8px 0;
  font-size:18px
}
#js_required_overlay p {
  margin:0;
  color:var(--rg-fg-weak)
}
html.js-ok #js_required_overlay {
  display:none
}
</style>
</head>
<body>
<div id="rgv1-topbar" class="rgv1-topbar" role="banner" aria-label="ReturnGuard">
  <div class="rgv1-title">ReturnGuard</div>
  <div class="rgv1-spacer"></div>
  <button class="rgv1-btn" id="rgv1-theme-toggle" title="Theme umschalten">üåó</button>
  <button class="rgv1-btn" id="rgv1-search" title="Suchen" aria-label="Suchen">üîé</button>
</div>
<div id="rgv1-bottombar" class="rgv1-bottombar" role="toolbar" aria-label="Export-Aktionen">
  <button class="rgv1-btn" id="rgv1-export-ics7"  title="Kalender (ICS 7 Tage)">ICS 7T</button>
  <button class="rgv1-btn" id="rgv1-export-ics14" title="Kalender (ICS 14 Tage)">ICS 14T</button>
  <button class="rgv1-btn" id="rgv1-export-csv"   title="CSV-Export">CSV</button>
  <button class="rgv1-btn" id="rgv1-export-json"  title="JSON-Export">JSON</button>
</div>
<button id="rgv1-fab" aria-label="Neu hinzuf√ºgen" title="Neu hinzuf√ºgen">+</button>


<!-- JS-required notice (shown if inline JS is blocked by viewer/CSP) -->
<div id="js_required_overlay" role="alert">
  <div class="box">
    <h2>JavaScript ist blockiert</h2>
    <p>Die Datei wurde in einem Viewer ge√∂ffnet, der Skripte deaktiviert (z.‚ÄØB. In‚ÄëApp‚ÄëVorschau). Dadurch funktionieren Buttons nicht.</p>
    <p><b>√ñffne die Datei in Chrome oder Firefox</b> (teilen ‚Üí ‚ÄûIm Browser √∂ffnen‚Äú) oder speichere sie und √∂ffne sie aus dem Download‚ÄëOrdner.</p>
    <p class="small" style="margin-top:10px">Hinweis: Service Worker & Benachrichtigungen funktionieren nur √ºber <b>https://</b> oder <b>http://localhost</b>.</p>
  </div>
</div>

<div class="chooser" id="chooser">
  <div class="box">
    <div><strong>Was willst du erfassen?</strong></div>
    <div class="opts">
      <div class="opt" data-open="cap">üì∏ Foto / OCR</div>
      <div class="opt" data-open="scan">üîé QR / Barcode</div>
      <div class="opt" data-open="manual">‚úçÔ∏è Manuell</div>
    </div>
    <div class="actions" style="justify-content:flex-end; margin-top:10px">
      <button id="chooser_close" class="btn">Schlie√üen</button>
    </div>
  </div>
</div>

<main class="wrap" role="main">
  <div class="grid">
    <!-- Capture / OCR card -->
    <section class="card" aria-labelledby="capTitle" id="card_cap" style="display:none">
      <div class="hd">
        <strong id="capTitle">Erfassen (Foto / OCR)</strong>
        <div class="small">Vorschlag durch H√§ndler-Profile (Amazon, MediaMarkt, IKEA, OBI, Google Store)</div>
      </div>
      <div class="bd">
        <div class="capture-grid">
          <div>
            <div class="dropzone" id="drop">
              <div>Ziehe ein Bild hierher oder</div>
              <div class="actions" style="justify-content:center; margin-top:8px">
                <label class="btn"><input id="file_pick" type="file" accept="image/*" class="hidden" />Aus Galerie w√§hlen</label>
                <label class="btn"><input id="file_cam" type="file" accept="image/*" capture="environment" class="hidden" />Kamera</label>
              </div>
              <div class="small" style="margin-top:8px">Tipp: Du kannst Bilder auch <b>einf√ºgen</b> (Strg/‚åò+V).</div>
              <div class="deskew-row">
                <label><input type="checkbox" id="deskew_on" checked /> Auto‚ÄëGerader√ºcken</label>
                <label><input type="checkbox" id="binarize_on" /> Kontrast/Binarisierung</label>
                <span class="small muted">Winkel: <span id="deskew_angle">0¬∞</span></span>
              </div>
            </div>
            <div class="preview" id="preview" style="margin-top:12px"></div>
            <div id="ocr_ui" class="hidden" style="margin-top:12px">
              <div class="small">Erkennung (de+en)‚Ä¶ <span id="ocr_info" class="conf"></span></div>
              <progress id="ocr_progress" value="0" max="1"></progress>
              <textarea id="ocr_text" rows="6" style="margin-top:8px" placeholder="Erkannter Text‚Ä¶"></textarea>
              <div class="actions" style="justify-content:space-between">
                <button id="btn_parse_profiles" class="btn">Mit H√§ndler‚ÄëProfilen parsen</button>
                <button id="btn_parse" class="primary">Generisch parsen</button>
              </div>
            </div>
          </div>
          <div>
            <div class="card" style="border:none">
              <div class="hd"><strong>Entwurf</strong><span class="small"> ‚Ä¢ pr√ºfe & √ºbernehme</span></div>
              <div class="bd">
                <div class="draft-grid">
                  <div><label for="d_name">Produkt*</label><input id="d_name" type="text" placeholder="z.B. Kopfh√∂rer Sony WH‚Äë1000XM5" /></div>
                  <div><label for="d_store">H√§ndler / Shop</label><input id="d_store" type="text" /></div>
                  <div><label for="d_date">Kaufdatum</label><input id="d_date" type="date" /></div>
                  <div><label for="d_price">Preis (‚Ç¨)</label><input id="d_price" type="number" min="0" step="0.01" inputmode="decimal" /></div>
                  <div><label for="d_return">R√ºckgabefrist (Tage)</label><input id="d_return" type="number" min="0" step="1" value="14" /></div>
                  <div><label for="d_warranty">Garantie (Monate)</label><input id="d_warranty" type="number" min="0" step="1" value="24" /></div>
                  <div style="grid-column: 1 / -1"><label for="d_notes">Notizen</label><input id="d_notes" type="text" placeholder="z.B. Seriennr., Farbe‚Ä¶" /></div>
                </div>
                <div class="chips" id="hint_chips"></div>
                <div class="actions" style="justify-content:flex-end">
                  <button id="btn_accept" class="primary">√úbernehmen</button>
                  <button id="btn_clear_draft" class="ghost">Entwurf leeren</button>
                </div>
                <div class="small muted" style="margin-top:8px">OCR & Parser sind N√§herungen. Werte pr√ºfen. Kein Rechtsrat.</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Scan QR/Barcode card -->
    <section class="card" aria-labelledby="scanTitle" id="card_scan" style="display:none">
      <div class="hd">
        <strong id="scanTitle">Scannen (QR / Barcode)</strong>
        <div class="small">EAN‚Äë13, Code‚Äë128, QR ‚Äì Kamera w√§hlen und starten</div>
      </div>
      <div class="bd">
        <div class="form-row">
          <div>
            <label for="camSel">Kamera</label>
            <select id="camSel"></select>
          </div>
          <div>
            <label>&nbsp;</label>
            <div class="actions">
              <button id="scan_start" class="primary">Start</button>
              <button id="scan_stop" class="ghost">Stopp</button>
            </div>
          </div>
        </div>
        <video id="scan_video" playsinline muted></video>
        <div class="actions" style="justify-content:space-between; align-items:center">
          <div class="small muted" id="scan_info">Bereit.</div>
          <div>
            <button id="scan_to_draft" class="btn" disabled>Treffer ‚Üí Entwurf</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Manual Add card -->
    <section class="card" aria-labelledby="formTitle" id="card_manual" style="display:none">
      <div class="hd">
        <strong id="formTitle">Neuer Einkauf (manuell)</strong>
        <div class="small">nur das N√∂tigste eintragen</div>
      </div>
      <div class="bd">
        <div class="form-row">
          <div>
            <label for="f_name">Produkt*</label>
            <input id="f_name" type="text" placeholder="z.B. Kopfh√∂rer Sony WH‚Äë1000XM5" required autocomplete="off" />
          </div>
          <div>
            <label for="f_store">H√§ndler / Shop</label>
            <input id="f_store" type="text" placeholder="z.B. MediaMarkt, Amazon‚Ä¶" autocomplete="off" />
          </div>
        </div>
        <div class="form-row-3" style="margin-top:12px">
          <div><label for="f_date">Kaufdatum</label><input id="f_date" type="date" /></div>
          <div><label for="f_return">R√ºckgabefrist (Tage)</label><input id="f_return" type="number" min="0" step="1" value="14" inputmode="numeric" /></div>
          <div><label for="f_warranty">Garantie (Monate)</label><input id="f_warranty" type="number" min="0" step="1" value="24" inputmode="numeric" /></div>
        </div>
        <div class="form-row" style="margin-top:12px">
          <div><label for="f_price">Preis (optional, ‚Ç¨)</label><input id="f_price" type="number" min="0" step="0.01" placeholder="z.B. 299.00" inputmode="decimal" /></div>
          <div><label for="f_notes">Notizen (optional)</label><input id="f_notes" type="text" placeholder="z.B. Seriennr., Farbe, Bundle‚Ä¶" /></div>
        </div>
        <div class="actions">
          <button type="button" class="primary" id="btn_add" aria-label="Eintrag hinzuf√ºgen">Hinzuf√ºgen</button>
          <button type="button" class="ghost" id="btn_demo">Demo-Daten f√ºllen</button>
          <button type="button" class="ghost" id="btn_clear">Alle archivieren</button>
        </div>
        <p class="small muted" style="margin-top:8px">Hinweis: Widerrufs-/R√ºckgaberechte unterscheiden sich je nach Land & Kaufart. Angaben sind Richtwerte.</p>
      </div>
    </section>

    <!-- List card -->
    <section class="card" aria-labelledby="listTitle">
      <div class="hd">
        <strong id="listTitle">Liste</strong><span class="small"> ‚Ä¢ offen & archiviert</span>
      </div>
      <div class="bd">
        <div class="toolbar" style="margin-bottom:12px">
          <input id="q" type="search" placeholder="Suchen (Produkt, H√§ndler)‚Ä¶" aria-label="Suchen" />
          <select id="filter" class="select" aria-label="Filter">
            <option value="open">Offen</option>
            <option value="archived">Archiv</option>
            <option value="all">Alle</option>
          </select>
          <select id="sort" class="select" aria-label="Sortieren">
            <option value="urgency">Sortierung: Dringlichkeit</option>
            <option value="date_asc">Kaufdatum ‚Üë</option>
            <option value="date_desc">Kaufdatum ‚Üì</option>
            <option value="name">Name A‚ÜíZ</option>
          </select>
          <button type="button" id="btn_export" class="ghost" aria-label="Export JSON">Export JSON</button>
          <button type="button" id="btn_import" class="ghost" aria-label="Import JSON">Import JSON</button>
          <button type="button" id="btn_csv" class="ghost" aria-label="CSV Export">CSV</button>
          <button type="button" id="btn_ics7" class="ghost" title="ICS mit R√ºckgaben der n√§chsten 7 Tage">ICS 7T</button>
          <button type="button" id="btn_ics14" class="ghost" title="ICS mit R√ºckgaben der n√§chsten 14 Tage">ICS 14T</button>
        </div>

        <div id="list"></div>
        <div id="empty" class="empty hidden">Noch keine Eintr√§ge. F√ºge oben einen Kauf hinzu.</div>
      </div>
    </section>

    <!-- App & Erinnerungen -->
    <section class="card" aria-labelledby="appTitle">
      <div class="hd">
        <strong id="appTitle">App & Erinnerungen</strong>
        <div class="small">Installierbar, Offline, lokale Benachrichtigungen</div>
      </div>
      <div class="bd">
        <div class="actions">
          <button id="btn_install" class="btn">Installieren</button>
          <button id="btn_notify" class="primary">Erinnerungen aktivieren</button>
          <button id="btn_test_notif" class="ghost">Test-Reminder</button>
        </div>
        <div class="status" style="margin-top:10px">
          <span class="pill"><span class="dot"></span><span id="sw_status">Service Worker: unbekannt</span></span>
          <span class="pill"><span class="dot"></span><span id="notif_status">Benachrichtigungen: unbekannt</span></span>
          <span class="pill"><span class="dot"></span><span id="bg_status">Background Sync: unbekannt</span></span>
        </div>
        <div class="note">
          Wichtig: Service Worker & Benachrichtigungen funktionieren nur √ºber <b>https://</b> oder <b>http://localhost</b>.
        </div>
      </div>
    </section>
  </div>

  <div class="foot">
    <div>v1.0 ‚Ä¢ Modernisierte UI, Theme-Auswahl & Parallax-Effekt</div>
  </div>
</main>

<dialog class="edit-sheet" id="editSheet" aria-labelledby="editTitle">
  <form method="dialog">
    <div class="sheet-hd">
      <strong id="editTitle">Eintrag bearbeiten</strong>
      <button type="button" id="btn_close_sheet" class="btn">Schlie√üen</button>
    </div>
    <div class="sheet-bd">
      <div class="form-row">
        <div><label for="e_name">Produkt*</label><input id="e_name" type="text" required /></div>
        <div><label for="e_store">H√§ndler / Shop</label><input id="e_store" type="text" /></div>
      </div>
      <div class="form-row-3" style="margin-top:12px">
        <div><label for="e_date">Kaufdatum</label><input id="e_date" type="date" /></div>
        <div><label for="e_return">R√ºckgabefrist (Tage)</label><input id="e_return" type="number" min="0" step="1" /></div>
        <div><label for="e_warranty">Garantie (Monate)</label><input id="e_warranty" type="number" min="0" step="1" /></div>
      </div>
      <div class="form-row" style="margin-top:12px">
        <div><label for="e_price">Preis (‚Ç¨)</label><input id="e_price" type="number" min="0" step="0.01" inputmode="decimal" /></div>
        <div><label for="e_notes">Notizen</label><input id="e_notes" type="text" /></div>
      </div>
    </div>
    <div class="sheet-actions">
      <button type="button" class="btn" id="btn_evidence">Beweise‚Ä¶</button>
      <button type="button" class="warn" id="btn_dup">Duplizieren</button>
      <button type="button" class="danger" id="btn_del">L√∂schen</button>
      <button type="submit" class="primary" id="btn_save">Speichern</button>
    </div>
  </form>
</dialog>

<dialog class="edit-sheet" id="evidenceSheet" aria-labelledby="evTitle">
  <div class="sheet-hd">
    <strong id="evTitle">Beweise</strong>
    <div class="actions">
      <label class="btn"><input id="ev_pick" type="file" multiple class="hidden" accept="image/*,application/pdf" />Dateien hinzuf√ºgen</label>
      <button id="ev_paste" class="btn">Aus Zwischenablage</button>
      <button id="ev_export" class="primary">ZIP Export</button>
      <button id="ev_close" class="btn">Schlie√üen</button>
    </div>
  </div>
  <div class="sheet-bd">
    <div id="ev_list" class="files"></div>
    <div id="ev_empty" class="empty">Noch keine Beweise. F√ºge Bilder/PDFs hinzu.</div>
  </div>
</dialog>

<script>
(() => {
  const $ = sel => document.querySelector(sel);
  const pad = n => String(n).padStart(2,'0');
  const todayISO = () => { const d = new Date(); return d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate()); };
  const toISODate = (d) => { const x = new Date(d); if (isNaN(+x)) return null; return x.toISOString().slice(0,10); };
  const mkDate = (iso) => new Date(iso + 'T12:00:00'); // midday fence against DST
  const addDays = (iso, days) => { const d = mkDate(iso); d.setDate(d.getDate() + (days || 0)); return d.toISOString().slice(0,10); };
  const addMonths = (iso, months) => { const d = mkDate(iso); d.setMonth(d.getMonth() + (months || 0)); return d.toISOString().slice(0,10); };
  const daysBetween = (aISO, bISO) => { const a = mkDate(aISO); const b = mkDate(bISO); return Math.round((b - a) / 86400000); };
  const fmtDate = (iso) => { if (!iso) return '‚Äî'; const d = mkDate(iso); return pad(d.getDate()) + '.' + pad(d.getMonth()+1) + '.' + d.getFullYear(); };
  const escapeHtml = s => String(s).replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":'&#39;'}[m]));

  // === IndexedDB ONLY ===
  let db;
  const DB_NAME = 'returnguard_data';
  const DB_VER = 5; // v0.8 bump
  function initDB(){
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, DB_VER);
      req.onupgradeneeded = (e) => {
        const d = e.target.result;
        if (!d.objectStoreNames.contains('files')){
          const s = d.createObjectStore('files', { keyPath:'id' });
          s.createIndex('by_item', 'itemId', { unique:false });
          s.createIndex('by_item_created', ['itemId','createdAt'], { unique:false });
        }
        if (!d.objectStoreNames.contains('kv')){
          d.createObjectStore('kv', { keyPath:'key' });
        }
      };
      req.onsuccess = (e) => { db = e.target.result; resolve(db); };
      req.onerror = (e) => reject(e.target.error);
    });
  }
  function kvGet(key){
    return new Promise((resolve, reject) => {
      const tx = db.transaction('kv','readonly'); const os = tx.objectStore('kv');
      const r = os.get(key); r.onsuccess = () => resolve(r.result ? r.result.value : null); r.onerror = () => reject(r.error);
    });
  }
  function kvPut(key, value){
    return new Promise((resolve, reject) => {
      const tx = db.transaction('kv','readwrite'); const os = tx.objectStore('kv');
      const r = os.put({ key, value, updatedAt: new Date().toISOString() }); r.onsuccess = () => resolve(); r.onerror = () => reject(r.error);
    });
  }

  const store = {
    async read(){ if (!db) await initDB(); let s = await kvGet('state'); if (!s || !Array.isArray(s.items)) s = {items:[]}; return s; },
    async write(data){ await kvPut('state', data); if (navigator.serviceWorker && navigator.serviceWorker.controller){ navigator.serviceWorker.controller.postMessage({type:'STATE_MIRROR'}); } }
  };
  let state = {items:[]};

  // Evidence DB helpers
  function dbAddFile(itemId, file){
    return new Promise((resolve, reject) => {
      const tx = db.transaction('files', 'readwrite');
      const os = tx.objectStore('files');
      const rec = { id: (crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2)), itemId, name: file.name || ('file_'+Date.now()), type: file.type || 'application/octet-stream', size: file.size || 0, data: null, createdAt: new Date().toISOString() };
      (file.arrayBuffer ? file.arrayBuffer() : new Response(file).arrayBuffer()).then(ab => {
        rec.data = ab; const req = os.add(rec); req.onsuccess = () => resolve(rec); req.onerror = () => reject(req.error);
      }).catch(err => reject(err));
    });
  }
  function dbListFiles(itemId){
    return new Promise((resolve, reject) => {
      const tx = db.transaction('files', 'readonly');
      const os = tx.objectStore('files');
      const ix = os.index('by_item_created');
      const range = IDBKeyRange.bound([itemId, ''], [itemId, '\Ôøø']);
      const out = [];
      ix.openCursor(range).onsuccess = (e) => { const cur = e.target.result; if (cur){ out.push(cur.value); cur.continue(); } else resolve(out); };
      tx.onerror = () => reject(tx.error);
    });
  }
  function dbDeleteFile(id){
    return new Promise((resolve, reject) => {
      const tx = db.transaction('files', 'readwrite'); const req = tx.objectStore('files').delete(id);
      tx.oncomplete = () => resolve(); req.onerror = () => reject(req.error);
    });
  }

  // Prefill dates
  document.addEventListener('DOMContentLoaded', async () => {
    $('#f_date').value = todayISO(); $('#d_date').value = todayISO();
    await initDB();
    state = await store.read();
    render();
    try{ await kvPut('state', state); }catch{}
  });

  // ===== Onboarding chooser =====
  const chooser = $('#chooser');
  const fab = $('#rgv1-fab');
  const chooserClose = $('#chooser_close');
  const show = id => { document.querySelectorAll('section[id^="card_"]').forEach(s => s.style.display='none'); $('#'+id).style.display='block'; window.scrollTo({top:0, behavior:'smooth'}); };
  if (fab) { fab.addEventListener('click', () => { chooser.style.display='flex'; }); }
  if (chooserClose) { chooserClose.addEventListener('click', () => { chooser.style.display='none'; }); }
  if (chooser) { chooser.addEventListener('click', (e) => { if (e.target === chooser) chooser.style.display='none'; }); }
  chooser.querySelectorAll('.opt').forEach(opt => opt.addEventListener('click', () => { chooser.style.display='none'; const t = opt.getAttribute('data-open'); if (t==='cap') show('card_cap'); if (t==='scan') show('card_scan'); if (t==='manual') show('card_manual'); }));
  // Default: show manual
  show('card_manual');

  // ===== Capture / OCR & parsing =====
  const drop = $('#drop'), filePick = $('#file_pick'), fileCam = $('#file_cam'), preview = $('#preview');
  const ocrUI = $('#ocr_ui'), ocrText = $('#ocr_text'), ocrInfo = $('#ocr_info'), ocrProgress = $('#ocr_progress');
  const deskewToggle = $('#deskew_on'), binToggle = $('#binarize_on'), deskewAngleEl = $('#deskew_angle');
  ;['dragenter','dragover'].forEach(ev => drop && drop.addEventListener(ev, e => { e.preventDefault(); drop.classList.add('drag'); }));
  ;['dragleave','drop'].forEach(ev => drop && drop.addEventListener(ev, e => { e.preventDefault(); drop.classList.remove('drag'); }));
  drop && drop.addEventListener('drop', e => { const f = e.dataTransfer.files && e.dataTransfer.files[0]; if (f) handleFile(f); });
  filePick && filePick.addEventListener('change', e => { const f = e.target.files && e.target.files[0]; if (f) handleFile(f); });
  fileCam && fileCam.addEventListener('change', e => { const f = e.target.files && e.target.files[0]; if (f) handleFile(f); });
  document.addEventListener('paste', (e) => {
    const items = e.clipboardData && e.clipboardData.items;
    if (!items) return;
    for (const it of items){ if (it.type && it.type.indexOf('image') === 0){ const f = it.getAsFile(); if (f) handleFile(f); break; } }
  });

  async function handleFile(file){
    preview.innerHTML = ''; ocrText.value = ''; ocrUI.classList.add('hidden');
    const { dataUrl, w, h } = await readAndScaleImage(file, 1600);
    let canv = document.createElement('canvas'); canv.width = w; canv.height = h;
    let ctx = canv.getContext('2d'); const img = await loadImage(dataUrl); ctx.drawImage(img, 0, 0, w, h);
    let angle = 0;
    if (deskewToggle.checked){ const res = autoDeskew(canv); angle = res.angle; canv = res.canvas; ctx = canv.getContext('2d'); deskewAngleEl.textContent = angle.toFixed(1)+'¬∞'; }
    else { deskewAngleEl.textContent = '0¬∞'; }
    if (binToggle.checked){ applyBinarize(canv, 1.2, 18); } // contrast 1.2, threshold 18
    preview.appendChild(canv);
    ocrUI.classList.remove('hidden'); ocrProgress.value = 0; ocrInfo.textContent = '(wird geladen)';
    try{
      const { data } = await Tesseract.recognize(canv, 'deu+eng', { logger: m => { if (m.status) ocrInfo.textContent = m.status; if (m.progress != null) ocrProgress.value = m.progress; } });
      ocrText.value = (data && data.text ? data.text : '').trim(); ocrInfo.textContent = 'fertig';
    }catch(err){ ocrText.value = 'OCR fehlgeschlagen: ' + err.message; ocrInfo.textContent = 'Fehler'; }
  }
  function autoDeskew(srcCanvas){
    const maxW = 800, ratio = Math.min(1, maxW / srcCanvas.width);
    const w = Math.round(srcCanvas.width * ratio), h = Math.round(srcCanvas.height * ratio);
    const small = document.createElement('canvas'); small.width = w; small.height = h;
    const sctx = small.getContext('2d'); sctx.drawImage(srcCanvas, 0, 0, w, h);
    const testAngles = []; for (let a=-6; a<=6; a+=0.5) testAngles.push(a);
    let bestAngle = 0, bestScore = -Infinity;
    for (const a of testAngles){ const rc = rotateCanvas(small, a); const score = rowProjectionScore(rc); if (score > bestScore){ bestScore = score; bestAngle = a; } }
    if (Math.abs(bestAngle) < 0.3) return { angle: 0, canvas: srcCanvas };
    return { angle: bestAngle, canvas: rotateCanvas(srcCanvas, bestAngle) };
  }
  function rowProjectionScore(canvas){
    const ctx = canvas.getContext('2d'); const { width:w, height:h } = canvas; const id = ctx.getImageData(0,0,w,h); const d = id.data;
    const rows = new Float32Array(h);
    for (let y=0; y<h; y++){ let sum = 0; for (let x=0; x<w; x++){ const i = (y*w + x) * 4; const lum = (0.299*d[i] + 0.587*d[i+1] + 0.114*d[i+2]); sum += (255 - lum); } rows[y] = sum; }
    let mean = 0; for (let i=0;i<h;i++) mean += rows[i]; mean /= h;
    let varSum = 0, diffSum = 0; for (let i=0;i<h;i++){ const v = rows[i]-mean; varSum += v*v; if (i>0) diffSum += Math.abs(rows[i]-rows[i-1]); }
    return (varSum / h) + (diffSum / h);
  }
  function rotateCanvas(src, angleDeg){
    const rad = angleDeg * Math.PI/180; const sw = src.width, sh = src.height; const cos = Math.abs(Math.cos(rad)), sin = Math.abs(Math.sin(rad));
    const dw = Math.floor(sw*cos + sh*sin), dh = Math.floor(sw*sin + cos*sh); const dst = document.createElement('canvas'); dst.width = dw; dst.height = dh;
    const ctx = dst.getContext('2d'); ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,dw,dh); ctx.translate(dw/2, dh/2); ctx.rotate(rad); ctx.drawImage(src, -sw/2, -sh/2); return dst;
  }
  function applyBinarize(canvas, contrast=1.2, thresh=18){
    const ctx = canvas.getContext('2d'); const id = ctx.getImageData(0,0,canvas.width,canvas.height); const d = id.data;
    for (let i=0;i<d.length;i+=4){
      // grayscale
      let g = 0.299*d[i] + 0.587*d[i+1] + 0.114*d[i+2];
      // contrast
      g = ((g-128)*contrast)+128;
      // threshold
      const v = g < (128 - thresh) ? 0 : (g > (128 + thresh) ? 255 : g);
      d[i]=d[i+1]=d[i+2]=v; d[i+3]=255;
    }
    ctx.putImageData(id,0,0);
  }
  function loadImage(src){ return new Promise((resolve, reject) => { const img = new Image(); img.onload = () => resolve(img); img.onerror = reject; img.src = src; }); }
  function readAndScaleImage(file, maxW){
    return new Promise((resolve, reject) => {
      const fr = new FileReader();
      fr.onload = () => { const img = new Image(); img.onload = () => {
        let w = img.width, h = img.height; if (w > maxW){ const ratio = maxW / w; w = Math.round(w * ratio); h = Math.round(h * ratio); }
        const c = document.createElement('canvas'); c.width = w; c.height = h; const cx = c.getContext('2d'); cx.fillStyle = '#ffffff'; cx.fillRect(0,0,w,h); cx.drawImage(img, 0, 0, w, h);
        resolve({ dataUrl: c.toDataURL('image/jpeg', 0.92), w, h }); }; img.onerror = reject; img.src = fr.result; };
      fr.onerror = reject; fr.readAsDataURL(file);
    });
  }

  // ===== Parsing (profiles first, then generic) =====
  function parseWithProfiles(text){
    const t = (text || '').replace(/\r/g,'').trim();
    const lines = t.split('\n').map(s => s.trim()).filter(Boolean);
    const raw = t.toLowerCase();
    const profiles = [
      { key:'amazon',      test: /(amazon\.?de|amazon\b)/i, fn: parseAmazon },
      { key:'mediamarkt',  test: /media\s?markt/i,            fn: parseMediaMarkt },
      { key:'ikea',        test: /\bikea\b/i,                fn: parseIkea },
      { key:'obi',         test: /\bobi\b/i,                 fn: parseObi },
      { key:'googlestore', test: /(store\.google|google\s+store)/i, fn: parseGoogleStore },
    ];
    for (const p of profiles){
      if (p.test.test(t)){ const out = p.fn(lines, t); out.hints = out.hints || []; out.hints.unshift({text:'Profil erkannt: '+p.key, level:'mid'}); return out; }
    }
    return parseGeneric(lines, t);
  }

  function firstMatch(lines, regexList){
    for (const rx of regexList){ for (const s of lines){ const m = s.match(rx); if (m) return { m, s, rx }; } }
    return null;
  }

  // AMAZON
  function parseAmazon(lines, text){
    const hints = []; let store='Amazon'; let dateISO = null; let price = null; let name = '';
    const dateHit = firstMatch(lines, [/Bestell(?:datum|ung)[:\s]+(\d{1,2}[.\/\-]\d{1,2}[.\/\-]\d{2,4})/i, /Rechnungsdatum[:\s]+(\d{1,2}[.\/\-]\d{1,2}[.\/\-]\d{2,4})/i]);
    if (dateHit){ dateISO = normalizeDate(dateHit.m[1]); hints.push({text:'Datum: '+dateHit.m[1], level:'high'}); }
    const priceHit = firstMatch(lines, [/Gesamt(?:betrag|summe)[:\s]*([0-9]{1,3}(?:[ .][0-9]{3})*(?:[,\.][0-9]{2}))/i, /Zahlbetrag[:\s]*([0-9]+[,\.][0-9]{2})/i]);
    if (priceHit){ price = normalizePrice(priceHit.m[1]); hints.push({text:'Preis: '+price.toFixed(2)+' ‚Ç¨', level:'high'}); }
    // item name: try lines near "Artikel", otherwise longest plausible
    const idxArtikel = lines.findIndex(s => /Artikel|Bezeichnung/i.test(s));
    if (idxArtikel>=0 && lines[idxArtikel+1]){ name = sanitizeName(lines[idxArtikel+1]); }
    if (!name){ name = bestName(lines, [/amazon/i]); }
    return baseOut({ store, dateISO, price, name }, hints);
  }

  // MEDIAMARKT
  function parseMediaMarkt(lines, text){
    const hints = []; let store='MediaMarkt'; let dateISO = null; let price = null; let name='';
    const dateHit = firstMatch(lines, [/Datum[:\s]+(\d{1,2}[.\/\-]\d{1,2}[.\/\-]\d{2,4})/i, /Kaufdatum[:\s]+(\d{1,2}[.\/\-]\d{1,2}[.\/\-]\d{2,4})/i]);
    if (dateHit){ dateISO = normalizeDate(dateHit.m[1]); hints.push({text:'Datum: '+dateHit.m[1], level:'mid'}); }
    const priceHit = firstMatch(lines, [/(?:Gesamtbetrag|SUMME|Total)[:\s]*([0-9]{1,3}(?:[ .][0-9]{3})*(?:[,\.][0-9]{2}))/i]);
    if (priceHit){ price = normalizePrice(priceHit.m[1]); hints.push({text:'Preis: '+price.toFixed(2)+' ‚Ç¨', level:'high'}); }
    name = bestName(lines, [/media\s?markt/i, /kassenbon|quittung|summe|ust|mwst/i]);
    return baseOut({ store, dateISO, price, name }, hints);
  }

  // IKEA
  function parseIkea(lines, text){
    const hints = []; let store='IKEA'; let dateISO=null; let price=null; let name='';
    const dateHit = firstMatch(lines, [/Datum[:\s]+(\d{1,2}[.\/\-]\d{1,2}[.\/\-]\d{2,4})/i, /(\d{1,2}[.\/\-]\d{1,2}[.\/\-]\d{2,4})\s+Uhr/i]);
    if (dateHit){ dateISO = normalizeDate(dateHit.m[1]); hints.push({text:'Datum: '+dateHit.m[1], level:'mid'}); }
    const priceHit = firstMatch(lines, [/(?:Gesamt|Summe|TOTAL)[:\s]*([0-9]{1,3}(?:[ .][0-9]{3})*(?:[,\.][0-9]{2}))/i]);
    if (priceHit){ price = normalizePrice(priceHit.m[1]); hints.push({text:'Preis: '+price.toFixed(2)+' ‚Ç¨', level:'mid'}); }
    name = bestName(lines, [/ikea/i, /kassenzettel|quittung|summe|mwst|ust/i]);
    return baseOut({ store, dateISO, price, name }, hints);
  }

  // OBI
  function parseObi(lines, text){
    const hints = []; let store='OBI'; let dateISO=null; let price=null; let name='';
    const dateHit = firstMatch(lines, [/Datum[:\s]+(\d{1,2}[.\/\-]\d{1,2}[.\/\-]\d{2,4})/i]);
    if (dateHit){ dateISO = normalizeDate(dateHit.m[1]); hints.push({text:'Datum: '+dateHit.m[1], level:'mid'}); }
    const priceHit = firstMatch(lines, [/(?:Gesamt|SUMME|Total)[:\s]*([0-9]{1,3}(?:[ .][0-9]{3})*(?:[,\.][0-9]{2}))/i]);
    if (priceHit){ price = normalizePrice(priceHit.m[1]); hints.push({text:'Preis: '+price.toFixed(2)+' ‚Ç¨', level:'mid'}); }
    name = bestName(lines, [/obi/i, /kassenbon|quittung|summe|mwst|ust/i]);
    return baseOut({ store, dateISO, price, name }, hints);
  }

  // GOOGLE STORE
  function parseGoogleStore(lines, text){
    const hints = []; let store='Google Store'; let dateISO=null; let price=null; let name='';
    const dateHit = firstMatch(lines, [/Bestelldatum[:\s]+(\d{1,2}[.\/\-]\d{1,2}[.\/\-]\d{2,4})/i, /Rechnungsdatum[:\s]+(\d{1,2}[.\/\-]\d{1,2}[.\/\-]\d{2,4})/i]);
    if (dateHit){ dateISO = normalizeDate(dateHit.m[1]); hints.push({text:'Datum: '+dateHit.m[1], level:'mid'}); }
    const priceHit = firstMatch(lines, [/Gesamt[:\s]*([0-9]{1,3}(?:[ .][0-9]{3})*(?:[,\.][0-9]{2}))/i, /Zahlbetrag[:\s]*([0-9]+[,\.][0-9]{2})/i]);
    if (priceHit){ price = normalizePrice(priceHit.m[1]); hints.push({text:'Preis: '+price.toFixed(2)+' ‚Ç¨', level:'high'}); }
    name = bestName(lines, [/google/i, /rechnung|bestellung|summe|mwst|ust/i]);
    return baseOut({ store, dateISO, price, name }, hints);
  }

  // GENERIC
  function parseGeneric(lines, text){
    const hints = [];
    // date
    let dateISO = null;
    const dateRx = [/(\d{4})[.\-\/](\d{1,2})[.\-\/](\d{1,2})/, /(\d{1,2})[.\-\/](\d{1,2})[.\-\/](\d{2,4})/];
    for (const line of lines){
      for (const rx of dateRx){
        const m = line.match(rx);
        if (m){
          let y, mo, d;
          if (rx === dateRx[0]){ y = +m[1]; mo = +m[2]; d = +m[3]; }
          else { d = +m[1]; mo = +m[2]; y = +m[3]; if (y < 100) y += 2000; }
          if (mo>=1 && mo<=12 && d>=1 && d<=31){ dateISO = y+'-'+pad(mo)+'-'+pad(d); break; }
        }
      }
      if (dateISO) break;
    }
    if (dateISO) hints.push({text:'Datum erkannt: '+fmtDate(dateISO), level:'mid'});
    // price
    let price = null, priceScore = 0;
    const pricePattern = /(?:‚Ç¨|EUR|CHF|USD)?\s*([0-9]{1,3}(?:[.\s][0-9]{3})*(?:[,\.][0-9]{2})|[0-9]+(?:[,\.][0-9]{2}))/g;
    for (const line of lines){
      let m; while ((m = pricePattern.exec(line))){
        const raw = m[1].replace(/\s/g,''); const norm = raw.indexOf(',')>-1 && raw.indexOf('.')>-1 ? raw.replace(/\./g,'').replace(',', '.') : (raw.indexOf(',')>-1 ? raw.replace(',', '.') : raw);
        const val = parseFloat(norm);
        let w = 1; if (/gesamt|summe|total|endbetrag|brutto|bezahl|zahlbetrag|barbetrag/i.test(line)) w += 5; if (/‚Ç¨|eur|chf|usd/i.test(line)) w += 1;
        if (!price || w > priceScore || (w===priceScore && val > price)) { price = val; priceScore = w; }
      }
    }
    if (price != null) hints.push({text:'Preis erkannt: '+price.toFixed(2)+' ‚Ç¨', level: priceScore>=6?'high':'mid'});
    // store and name
    const avoid = /rechn|receipt|kassenbon|quittung|ust|mwst|steuer|summe|total|betrag|kund|iban|bic|liefer|adresse|stra√üe|str\.|plz|ust-id|ustid|uid|tel|fax|mail|email|steuer-nr|bank/i;
    const brandHints = /(amazon|mediamarkt|saturn|obi|bauhaus|ikea|spar|billa|hofer|aldi|lidl|intersport|xxx|m√ºller|dm|google|apple|samsung|bosch|hornbach|conrad)/i;
    let store = '';
    for (let i=0;i<Math.min(lines.length,20);i++){
      const s = lines[i]; const letters = (s.match(/[A-Za-z√Ñ√ñ√ú√§√∂√º√ü]/g)||[]).length; const digits = (s.match(/[0-9]/g)||[]).length;
      if (letters>=3 && letters>digits && s.length>=2 && s.length<=48 && !avoid.test(s)){ store = s.replace(/\s{2,}/g,' ').trim(); if (brandHints.test(s)) { hints.push({text:'H√§ndler: '+store, level:'high'}); } break; }
    }
    const name = bestName(lines, [brandHints, avoid]);
    return baseOut({ store, dateISO, price, name }, hints);
  }

  function baseOut(core, hints){
    const d = { name: core.name || 'Unbenannt', store: core.store || '', date: core.dateISO || todayISO(), price: core.price != null ? core.price : null, returnDays: 14, warrantyMonths: 24, notes: '' };
    return { data: d, hints };
  }
  function bestName(lines, blacklist){
    const bl = blacklist || []; const bad = (s) => bl.some(rx => rx.test && rx.test(s));
    let cand = '';
    for (const s of lines){
      if (bad(s)) continue;
      const letters = (s.match(/[A-Za-z√Ñ√ñ√ú√§√∂√º√ü]/g)||[]).length;
      if (letters < 3) continue;
      const ln = s.length;
      if (ln <= 64 && ln >= 6){
        cand = s; break;
      }
    }
    if (!cand){
      const sorted = lines.filter(s => !bad(s)).sort((a,b) => b.length - a.length);
      cand = sorted[0] || 'Unbenannt';
    }
    return sanitizeName(cand);
  }
  function sanitizeName(s){ return s.replace(/\s{2,}/g,' ').replace(/[|‚Ä¢¬∑]{1,}/g,' ').trim(); }
  function normalizeDate(s){
    s = s.replace(/\s/g,'');
    let m = s.match(/^(\d{1,2})[.\/\-](\d{1,2})[.\/\-](\d{2,4})$/);
    if (m){ let d=+m[1], mo=+m[2], y=+m[3]; if (y<100) y+=2000; return y+'-'+pad(mo)+'-'+pad(d); }
    m = s.match(/^(\d{4})[.\/\-](\d{1,2})[.\/\-](\d{1,2})$/);
    if (m){ let y=+m[1], mo=+m[2], d=+m[3]; return y+'-'+pad(mo)+'-'+pad(d); }
    return null;
  }
  function normalizePrice(s){
    const raw = String(s).replace(/\s/g,'');
    const norm = raw.indexOf(',')>-1 && raw.indexOf('.')>-1 ? raw.replace(/\./g,'').replace(',', '.') : (raw.indexOf(',')>-1 ? raw.replace(',', '.') : raw);
    const val = parseFloat(norm); return isNaN(val) ? null : val;
  }

  function parseDraftGeneric(text){ return parseGeneric(text.split('\n'), text); }

  $('#btn_parse').addEventListener('click', () => { const t = ocrText.value || ''; const out = parseGeneric(t.split('\n'), t); fillDraft(out.data); paintHints(out.hints); });
  $('#btn_parse_profiles').addEventListener('click', () => { const t = ocrText.value || ''; const out = parseWithProfiles(t); fillDraft(out.data); paintHints(out.hints); });

  function paintHints(hints){
    const host = $('#hint_chips'); host.innerHTML = ''; (hints||[]).forEach(h => {
      const el = document.createElement('span'); el.className = 'chip ' + (h.level||'mid'); el.textContent = h.text; host.appendChild(el);
    });
  }
  function fillDraft(d){ $('#d_name').value = d.name || ''; $('#d_store').value = d.store || ''; $('#d_date').value = d.date || todayISO(); $('#d_price').value = d.price != null ? String(d.price) : ''; $('#d_return').value = d.returnDays != null ? String(d.returnDays) : '14'; $('#d_warranty').value = d.warrantyMonths != null ? String(d.warrantyMonths) : '24'; $('#d_notes').value = d.notes || ''; }

  $('#btn_accept').addEventListener('click', async () => {
    const name = $('#d_name').value.trim();
    if (!name){ alert('Produktname ist Pflicht.'); $('#d_name').focus(); return; }
    const item = { id: (crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2)), name, store: $('#d_store').value.trim(), date: $('#d_date').value || todayISO(), returnDays: Math.max(0, parseInt($('#d_return').value || '0',10)||0), warrantyMonths: Math.max(0, parseInt($('#d_warranty').value || '0',10)||0), price: parseFloat($('#d_price').value || '0') || 0, notes: $('#d_notes').value.trim(), archived:false, createdAt: new Date().toISOString() };
    state.items.push(item); await store.write(state); fillDraft({}); render(); alert('Entwurf √ºbernommen.');
  });
  $('#btn_clear_draft').addEventListener('click', () => fillDraft({}));

  // ===== QR/Barcode scanning =====
  const videoEl = $('#scan_video'), camSel = $('#camSel'), scanStart = $('#scan_start'), scanStop = $('#scan_stop'), scanInfo = $('#scan_info'), scanToDraft = $('#scan_to_draft');
  let codeReader = null, currentDeviceId = null, lastResult = null;
  async function initCams(){
    try{
      codeReader = new ZXing.BrowserMultiFormatReader();
      const devices = await codeReader.listVideoInputDevices();
      camSel.innerHTML = '';
      devices.forEach((d, idx) => { const opt = document.createElement('option'); opt.value = d.deviceId; opt.textContent = d.label || ('Kamera ' + (idx+1)); camSel.appendChild(opt); });
      if (devices[0]) currentDeviceId = devices[0].deviceId;
      scanInfo.textContent = devices.length ? 'Kamera bereit.' : 'Keine Kamera gefunden.';
    }catch(e){ scanInfo.textContent = 'Kamera-Init fehlgeschlagen: ' + e.message; }
  }
  camSel && camSel.addEventListener('change', () => currentDeviceId = camSel.value);
  scanStart && scanStart.addEventListener('click', async (e) => {
    e.preventDefault();
    if (!codeReader){ await initCams(); }
    if (!currentDeviceId){ scanInfo.textContent = 'Keine Kamera verf√ºgbar.'; return; }
    lastResult = null; scanToDraft.disabled = true; scanInfo.textContent = 'Scanning‚Ä¶ (QR, EAN‚Äë13, Code‚Äë128)';
    try{
      await codeReader.decodeFromVideoDevice(currentDeviceId, videoEl, (res, err) => {
        if (res){ lastResult = res; scanInfo.textContent = 'Treffer: [' + res.getBarcodeFormat() + '] ' + res.getText().slice(0,200); scanToDraft.disabled = false; }
      });
    }catch(e){ scanInfo.textContent = 'Fehler: ' + e.message; }
  });
  scanStop && scanStop.addEventListener('click', (e) => { e.preventDefault(); if (codeReader) codeReader.reset(); scanInfo.textContent = 'Gestoppt.'; });
  scanToDraft && scanToDraft.addEventListener('click', () => {
    if (!lastResult) return;
    const fmt = String(lastResult.getBarcodeFormat ? lastResult.getBarcodeFormat() : lastResult.format || 'TEXT');
    const txt = String(lastResult.getText ? lastResult.getText() : lastResult.text || '');
    const d = { name:'', store:'', date: todayISO(), price:null, returnDays:14, warrantyMonths:24, notes:'' };
    if (/^https?:\/\//.test(txt)){ try{ const u = new URL(txt); d.store = u.hostname.replace(/^www\./,''); d.name = 'Bestellung / Link'; d.notes = txt; }catch{ d.notes = txt; } }
    else if (/^\d{13}$/.test(txt) && (fmt==='EAN_13' || /EAN/.test(fmt))){ d.name = 'EAN ' + txt; d.notes = 'Barcode: EAN‚Äë13 ' + txt; }
    else { d.name = txt.slice(0,64); d.notes = 'Scan: ['+fmt+'] ' + (txt.length>120 ? txt.slice(0,120)+'‚Ä¶' : txt); }
    fillDraft(d); scanToDraft.disabled = true; show('card_cap');
  });
  initCams();

  // ===== CRUD & UI =====
  $('#btn_add') && $('#btn_add').addEventListener('click', async () => {
    const name = $('#f_name').value.trim();
    if (!name){ alert('Produktname ist Pflicht.'); $('#f_name').focus(); return; }
    const item = { id: (crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2)), name, store: $('#f_store').value.trim(), date: $('#f_date').value || todayISO(), returnDays: Math.max(0, parseInt($('#f_return').value || '0',10)||0), warrantyMonths: Math.max(0, parseInt($('#f_warranty').value || '0',10)||0), price: parseFloat($('#f_price').value || '0') || 0, notes: $('#f_notes').value.trim(), archived:false, createdAt: new Date().toISOString() };
    state.items.push(item); await store.write(state); clearForm(); render();
  });
  $('#btn_demo') && $('#btn_demo').addEventListener('click', async () => {
    const base = todayISO();
    const samples = [
      {name:'Staubsauger Miele Boost CX1', store:'Spar', date:addDays(base,-10), returnDays:14, warrantyMonths:24, price:249.00, notes:'Farbe Graphitgrau'},
      {name:'Winterschuhe f√ºr Sohn', store:'Intersport', date:addDays(base,-1), returnDays:30, warrantyMonths:0, price:79.90, notes:''},
      {name:'Smartphone Google Pixel', store:'Google Store', date:addDays(base,-25), returnDays:14, warrantyMonths:24, price:899.00, notes:'Trade-in offen'},
      {name:'Bohrhammer Bosch', store:'OBI', date:addDays(base,-60), returnDays:14, warrantyMonths:36, price:159.99, notes:'Garantieverl√§ngerung inkl.'},
      {name:'Bluetooth-Kopfh√∂rer', store:'Amazon', date:addDays(base,-5), returnDays:30, warrantyMonths:24, price:119.00, notes:'Retoure testen'}
    ];
    samples.forEach(s => state.items.push({ id:(crypto.randomUUID?crypto.randomUUID():Math.random().toString(36).slice(2)), archived:false, createdAt:new Date().toISOString(), ...s }));
    await store.write(state); render();
  });
  $('#btn_clear') && $('#btn_clear').addEventListener('click', async () => { if (!confirm('Alle offenen Eintr√§ge ins Archiv verschieben?')) return; state.items.forEach(it => it.archived = true); await store.write(state); render(); });
  $('#q') && $('#q').addEventListener('input', () => render()); $('#filter') && $('#filter').addEventListener('change', () => render()); $('#sort') && $('#sort').addEventListener('change', () => render());

  $('#btn_export') && $('#btn_export').addEventListener('click', async () => { const data = JSON.stringify(state, null, 2); downloadFile('returnguard_export.json', data, 'application/json'); });
  $('#btn_import') && $('#btn_import').addEventListener('click', async () => {
    const file = await pickFile('.json'); if (!file) return; const text = await file.text();
    try{ const data = JSON.parse(text); if (!data || !Array.isArray(data.items)) throw new Error('Ung√ºltiges Format'); state = data; await store.write(state); render(); alert('Import erfolgreich.'); }
    catch(e){ alert('Import fehlgeschlagen: ' + e.message); }
  });
  $('#btn_csv') && $('#btn_csv').addEventListener('click', async () => {
    const rows = [['ID','Produkt','H√§ndler','Kaufdatum','R√ºckgabefrist(Tage)','R√ºckgabe bis','Garantie(Monate)','Garantie bis','Preis','Archiv','Notizen']];
    state.items.forEach(it => { const {returnDue, warrantyDue} = computeDue(it);
      rows.push([ it.id, it.name, it.store, it.date, it.returnDays, returnDue, it.warrantyMonths, warrantyDue, it.price ? it.price.toFixed(2).replace('.', ',') : '', it.archived ? 'ja' : 'nein', it.notes || '' ]);
    });
    const csv = rows.map(r => r.map(cell => `\"${String(cell).replace(/\"/g,'\"\"')}\"`).join(';')).join('\n');
    downloadFile('returnguard_export.csv', csv, 'text/csv');
  });
  $('#btn_ics7') && $('#btn_ics7').addEventListener('click', () => bulkICS(7)); $('#btn_ics14') && $('#btn_ics14').addEventListener('click', () => bulkICS(14));
  function bulkICS(days){
    const now = todayISO(), until = addDays(now, days);
    const items = state.items.filter(it => { if (it.archived) return false; const {returnDue, daysToReturn} = computeDue(it); if (!returnDue) return false; const d = returnDue; return d >= now && d <= until && daysToReturn >= 0; });
    if (items.length === 0){ alert('Keine R√ºckgaben im gew√§hlten Zeitraum.'); return; }
    const lines = [ 'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//ReturnGuard//DE','CALSCALE:GREGORIAN','METHOD:PUBLISH' ];
    items.forEach(it => { const dueISO = computeDue(it).returnDue; const dt = dueISO.replace(/-/g,''); const dtEnd = addDays(dueISO,1).replace(/-/g,''); const nowStamp = new Date().toISOString().replace(/[-:]/g,'').split('.')[0] + 'Z'; const uidStr = it.id + '-bulk@returnguard.local';
      lines.push('BEGIN:VEVENT','UID:'+uidStr,'DTSTAMP:'+nowStamp,'SUMMARY:'+escapeICS('Letzter Tag R√ºckgabe ‚Äì ' + it.name),'DTSTART;VALUE=DATE:'+dt,'DTEND;VALUE=DATE:'+dtEnd,'DESCRIPTION:'+escapeICS(['H√§ndler: ' + (it.store||'‚Äî'), 'Gekauft am: ' + fmtDate(it.date), 'Notizen: ' + (it.notes||'‚Äî')].join('\n')),'END:VEVENT');
    });
    lines.push('END:VCALENDAR'); const ics = lines.join('\r\n'); downloadFile('ReturnGuard_Rueckgaben_next_'+days+'d.ics', ics, 'text/calendar');
  }
  function escapeICS(s){ return String(s).replace(/[\n,;\\]/g, m => ({'\n':'\n', ',':'\\,',';':'\\;','\\\\':'\\\\\\\\'}[m] || m)); }
  function clearForm(){ $('#f_name').value=''; $('#f_store').value=''; $('#f_date').value=todayISO(); $('#f_return').value='14'; $('#f_warranty').value='24'; $('#f_price').value=''; $('#f_notes').value=''; $('#f_name').focus(); }

  function computeDue(it){
    const returnDue = it.returnDays ? addDays(it.date, it.returnDays) : null;
    const warrantyDue = it.warrantyMonths ? addMonths(it.date, it.warrantyMonths) : null;
    const now = todayISO(); const daysToReturn = returnDue ? daysBetween(now, returnDue) : null; const daysToWarranty = warrantyDue ? daysBetween(now, warrantyDue) : null;
    const urgency = (daysToReturn==null) ? 99999 : daysToReturn; return { returnDue, warrantyDue, daysToReturn, daysToWarranty, urgency };
  }
  function urgencyBadge(days){
    if (days == null) return '<span class="badge ok">keine R√ºckgabe</span>';
    if (days < 0) return '<span class="badge due">verpasst</span>';
    if (days === 0) return '<span class="badge due">heute</span>';
    if (days <= 3) return '<span class="badge soon">in '+days+' Tg</span>';
    if (days <= 10) return '<span class="badge">in '+days+' Tg</span>';
    return '<span class="badge ok">in '+days+' Tg</span>';
  }

  function render(){
    const qEl=$('#q'); const filterEl=$('#filter'); const sortEl=$('#sort'); const q=((qEl && qEl.value) || '').trim().toLowerCase(); const filter=(filterEl && filterEl.value) || 'open'; const sort=(sortEl && sortEl.value) || 'urgency';
    const kpiEl = document.getElementById('kpi');
    const k = { dueToday:0, dueSoon:0, ok:0, missed:0 };
    state.items.filter(it => !it.archived).forEach(it => { const {daysToReturn} = computeDue(it);
      if (daysToReturn == null) { k.ok++; return; } if (daysToReturn < 0) k.missed++; else if (daysToReturn === 0) k.dueToday++; else if (daysToReturn <= 3) k.dueSoon++; else k.ok++; });
    if (kpiEl) kpiEl.innerHTML = `<span class="pill due"><span class="dot"></span> Heute f√§llig: <strong>${k.dueToday}</strong></span>
      <span class="pill soon"><span class="dot"></span> In 3 Tagen: <strong>${k.dueSoon}</strong></span>
      <span class="pill ok"><span class="dot"></span> OK: <strong>${k.ok}</strong></span>
      <span class="pill"><span class="dot"></span> Verpasst: <strong>${k.missed}</strong></span>`;

    let items = state.items.filter(it => { if (filter==='open' && it.archived) return false; if (filter==='archived' && !it.archived) return false; if (!q) return true; const t = (it.name + ' ' + (it.store||'') + ' ' + (it.notes||'')).toLowerCase(); return t.includes(q); });

    items.sort((a,b) => { const A = computeDue(a), B = computeDue(b);
      if (sort==='urgency') return A.urgency - B.urgency; if (sort==='date_asc') return a.date.localeCompare(b.date);
      if (sort==='date_desc') return b.date.localeCompare(a.date); if (sort==='name') return a.name.localeCompare(b.name); return 0;
    });

    const listEl = document.getElementById('list'); const emptyEl = document.getElementById('empty');
    if (items.length === 0){ listEl.innerHTML = ''; emptyEl.classList.remove('hidden'); return; }
    emptyEl.classList.add('hidden');
    let html = `<table role="table"><thead><tr>
      <th scope="col">Produkt</th><th scope="col" class="nowrap">Kaufdatum</th><th scope="col" class="nowrap">R√ºckgabe bis</th><th scope="col" class="nowrap">Garantie bis</th><th scope="col" class="right nowrap">Preis</th><th scope="col" class="nowrap">Aktionen</th>
    </tr></thead><tbody>`;
    items.forEach(it => {
      const {returnDue, warrantyDue, daysToReturn} = computeDue(it);
      const archBtn = it.archived ? '<button type="button" class="btn" data-act="unarchive" data-id="'+it.id+'">Wiederherstellen<\/button>' : '<button type="button" class="btn" data-act="archive" data-id="'+it.id+'">Archivieren<\/button>';
      html += `<tr>
        <td><div><strong>${escapeHtml(it.name)}</strong></div><div class="tag">${escapeHtml(it.store || '‚Äî')}</div></td>
        <td class="nowrap">${fmtDate(it.date)}</td>
        <td class="nowrap">${returnDue ? fmtDate(returnDue) : '‚Äî'}<div class="small">${urgencyBadge(daysToReturn)}</div></td>
        <td class="nowrap">${warrantyDue ? fmtDate(warrantyDue) : '‚Äî'}</td>
        <td class="right nowrap">${it.price ? (it.price.toFixed(2) + ' ‚Ç¨') : '‚Äî'}</td>
        <td class="nowrap">
          <div class="row-actions">
            <button type="button" class="btn" data-act="calendar" data-id="${it.id}">Kalender</button>
            <button type="button" class="btn" data-act="edit" data-id="${it.id}">Bearbeiten</button>
            ${archBtn}
            <button type="button" class="btn" data-act="evidence" data-id="${it.id}">Beweise</button>
            <button type="button" class="btn warn" data-act="duplicate" data-id="${it.id}">Duplizieren</button>
            <button type="button" class="btn danger" data-act="delete" data-id="${it.id}">L√∂schen</button>
          </div>
        </td>
      </tr>`;
    });
    html += '</tbody></table>'; listEl.innerHTML = html;

    listEl.querySelectorAll('button[data-act]').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const id = e.currentTarget.getAttribute('data-id');
        const act = e.currentTarget.getAttribute('data-act');
        const it = state.items.find(x => x.id === id);
        if (!it) return;
        if (act === 'delete'){ if (!confirm('Eintrag wirklich l√∂schen?')) return; state.items = state.items.filter(x => x.id !== id); await store.write(state); render(); return; }
        if (act === 'archive'){ it.archived = true; await store.write(state); render(); return; }
        if (act === 'unarchive'){ it.archived = false; await store.write(state); render(); return; }
        if (act === 'edit'){ openEditor(it); return; }
        if (act === 'calendar'){ openCalendar(it); return; }
        if (act === 'duplicate'){ const copy = JSON.parse(JSON.stringify(it)); copy.id = (crypto.randomUUID?crypto.randomUUID():Math.random().toString(36).slice(2)); copy.createdAt = new Date().toISOString(); copy.archived = false; state.items.push(copy); await store.write(state); render(); return; }
        if (act === 'evidence'){ openEvidence(it); return; }
      });
    });
  }

  // Edit sheet logic
  const sheet = document.getElementById('editSheet'); let currentEditId = null;
  function openEditor(it){
    currentEditId = it.id; document.getElementById('e_name').value = it.name; document.getElementById('e_store').value = it.store || ''; document.getElementById('e_date').value = it.date || todayISO();
    document.getElementById('e_return').value = it.returnDays || 0; document.getElementById('e_warranty').value = it.warrantyMonths || 0; document.getElementById('e_price').value = it.price || 0; document.getElementById('e_notes').value = it.notes || '';
    if (!sheet.open) sheet.showModal(); document.getElementById('e_name').focus();
  }
  document.getElementById('btn_close_sheet').addEventListener('click', () => sheet.close());
  document.getElementById('btn_save').addEventListener('click', async (ev) => {
    ev.preventDefault(); if (!currentEditId) { sheet.close(); return; }
    const it = state.items.find(x => x.id === currentEditId); if (!it){ sheet.close(); return; }
    it.name = document.getElementById('e_name').value.trim() || it.name; it.store = document.getElementById('e_store').value.trim(); it.date = toISODate(document.getElementById('e_date').value) || it.date;
    it.returnDays = Math.max(0, parseInt(document.getElementById('e_return').value||'0',10) || 0); it.warrantyMonths = Math.max(0, parseInt(document.getElementById('e_warranty').value||'0',10) || 0);
    it.price = Math.max(0, parseFloat(document.getElementById('e_price').value||'0') || 0); it.notes = document.getElementById('e_notes').value.trim(); await store.write(state); sheet.close(); render();
  });
  document.getElementById('btn_del').addEventListener('click', async () => { if (!currentEditId) return; if (!confirm('Eintrag wirklich l√∂schen?')) return; state.items = state.items.filter(x => x.id !== currentEditId); await store.write(state); sheet.close(); render(); });
  document.getElementById('btn_dup').addEventListener('click', async () => { if (!currentEditId) return; const src = state.items.find(x => x.id === currentEditId); if (!src) return; const copy = JSON.parse(JSON.stringify(src)); copy.id = (crypto.randomUUID?crypto.randomUUID():Math.random().toString(36).slice(2)); copy.archived = false; copy.createdAt = new Date().toISOString(); state.items.push(copy); await store.write(state); render(); alert('Duplikat angelegt.'); });
  document.getElementById('btn_evidence').addEventListener('click', () => { const it = state.items.find(x => x.id === currentEditId); if (it) openEvidence(it); });

  function openCalendar(it){
    const {returnDue} = computeDue(it); if (!returnDue){ alert('F√ºr dieses Produkt ist keine R√ºckgabefrist gesetzt.'); return; }
    const start = returnDue.replace(/-/g,''), endDate = addDays(returnDue, 1).replace(/-/g,'');
    const title = encodeURIComponent('Letzter Tag R√ºckgabe ‚Äì ' + it.name);
    const details = encodeURIComponent(['H√§ndler: ' + (it.store||'‚Äî'), 'Gekauft am: ' + fmtDate(it.date), 'Notizen: ' + (it.notes||'‚Äî')].join('\n'));
    const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${start}/${endDate}&details=${details}`;
    const ics = buildICS(it, returnDue);
    const choice = confirm('Google Kalender √∂ffnen?\n\nOK = Google Kalender\nAbbrechen = .ics herunterladen');
    if (choice){ window.open(url, '_blank', 'noopener'); } else { downloadFile(('ReturnGuard_'+it.name+'_Rueckgabe.ics').replace(/[^a-z0-9_\-\.]+/gi,'_'), ics, 'text/calendar'); }
  }
  function buildICS(it, dueISO){
    const dt = dueISO.replace(/-/g,''), dtEnd = addDays(dueISO,1).replace(/-/g,'');
    const now = new Date().toISOString().replace(/[-:]/g,'').split('.')[0] + 'Z'; const uidStr = it.id + '@returnguard.local';
    const lines = [ 'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//ReturnGuard//DE','BEGIN:VEVENT','UID:'+uidStr,'DTSTAMP:'+now,'SUMMARY:' + escapeICS('Letzter Tag R√ºckgabe ‚Äì ' + it.name),'DTSTART;VALUE=DATE:'+dt,'DTEND;VALUE=DATE:'+dtEnd,'DESCRIPTION:' + escapeICS(['H√§ndler: ' + (it.store||'‚Äî'), 'Gekauft am: ' + fmtDate(it.date), 'Notizen: ' + (it.notes||'‚Äî')].join('\n')),'END:VEVENT','END:VCALENDAR' ];
    return lines.join('\r\n');
  }

  // Evidence UI
  const evidenceSheet = document.getElementById('evidenceSheet'); const evList = document.getElementById('ev_list'); const evEmpty = document.getElementById('ev_empty'); const evPick = document.getElementById('ev_pick'); const evPaste = document.getElementById('ev_paste'); const evExport = document.getElementById('ev_export'); const evClose = document.getElementById('ev_close');
  let evCurrentItemId = null;
  async function openEvidence(it){
    evCurrentItemId = it.id; document.getElementById('evTitle').textContent = 'Beweise ‚Äì ' + it.name;
    await renderEvidence();
    if (!evidenceSheet.open) evidenceSheet.showModal();
  }
  evClose.addEventListener('click', () => evidenceSheet.close());
  evPick.addEventListener('change', async (e) => { const files = Array.from(e.target.files || []); if (!files.length) return; for (const f of files){ await dbAddFile(evCurrentItemId, f); } await renderEvidence(); e.target.value=''; });
  evPaste.addEventListener('click', async () => {
    if (!navigator.clipboard || !navigator.clipboard.read){ alert('Zwischenablage-Zugriff nicht verf√ºgbar.'); return; }
    try{
      const items = await navigator.clipboard.read();
      for (const it of items){
        for (const type of it.types){
          if (type.startsWith('image/') || type==='application/pdf'){
            const blob = await it.getType(type);
            const f = new File([blob], 'Clipboard_' + Date.now() + (type==='application/pdf'?'.pdf':'.png'), { type });
            await dbAddFile(evCurrentItemId, f);
          }
        }
      }
      await renderEvidence();
    }catch(e){ alert('Zwischenablage: ' + e.message); }
  });
  evExport.addEventListener('click', async () => {
    if (!evCurrentItemId) return;
    const item = state.items.find(x => x.id === evCurrentItemId);
    const files = await dbListFiles(evCurrentItemId);
    if (!files.length){ alert('Keine Beweise zum Export.'); return; }
    const zip = new JSZip();
    const manifest = { exportAt: new Date().toISOString(), item: { ...item, dueReturn: computeDue(item).returnDue, dueWarranty: computeDue(item).warrantyDue } };
    zip.file('manifest.json', JSON.stringify(manifest, null, 2));
    files.forEach((f, idx) => { const base = (item.date||'').replace(/-/g,'') + '_' + item.id + '_' + String(idx+1).padStart(2,'0') + '_' + (f.name||('file_'+idx)); zip.file(base, f.data, {binary:true}); });
    const blob = await zip.generateAsync({ type:'blob' }); downloadFile('ReturnGuard_Evidence_' + (item.name||'item').replace(/[^a-z0-9_\-\.]+/gi,'_') + '_' + (item.date||'').replace(/-/g,'') + '.zip', blob, 'application/zip');
  });
  async function renderEvidence(){
    if (!evCurrentItemId){ evList.innerHTML=''; evEmpty.classList.remove('hidden'); return; }
    const files = await dbListFiles(evCurrentItemId);
    evList.innerHTML = '';
    if (!files.length){ evEmpty.classList.remove('hidden'); return; }
    evEmpty.classList.add('hidden');
    for (const f of files){
      const card = document.createElement('div'); card.className = 'file-card';
      const th = document.createElement('div'); th.className = 'thumb';
      if (f.type && f.type.startsWith('image/')){ const img = document.createElement('img'); const blob = new Blob([f.data], { type: f.type || 'application/octet-stream' }); img.src = URL.createObjectURL(blob); th.appendChild(img); img.onload = () => URL.revokeObjectURL(img.src); }
      else { th.textContent = f.type ? f.type.split('/').pop().toUpperCase() : 'FILE'; }
      const info = document.createElement('div'); info.style.flex='1';
      const meta = document.createElement('div'); meta.className='small muted';
      meta.textContent = (f.type||'datei') + ' ‚Ä¢ ' + Math.round((f.size||0)/1024) + ' KB ‚Ä¢ ' + new Date(f.createdAt).toLocaleString();
      info.innerHTML = `<div><strong>${escapeHtml(f.name||'Datei')}</strong></div>`; info.appendChild(meta);
      const del = document.createElement('button'); del.className='btn danger'; del.textContent='L√∂schen';
      del.addEventListener('click', async ()=>{ if (!confirm('Datei l√∂schen?')) return; await dbDeleteFile(f.id); await renderEvidence(); });
      card.appendChild(th); card.appendChild(info); card.appendChild(del); evList.appendChild(card);
    }
  }

  // ===== PWA: Manifest & Service Worker =====
  const manifestLink = document.createElement('link'); manifestLink.rel = 'manifest'; document.head.appendChild(manifestLink);
  let deferredPrompt = null;
  window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; document.getElementById('btn_install').disabled = false; });
  document.getElementById('btn_install').addEventListener('click', async () => {
    if (!deferredPrompt){ alert('Install-Prompt noch nicht verf√ºgbar. Versuche √ºber Browser-Men√º ‚ÄûZum Startbildschirm hinzuf√ºgen‚Äú.'); return; }
    deferredPrompt.prompt(); const choice = await deferredPrompt.userChoice; if (choice && choice.outcome === 'accepted'){ document.getElementById('btn_install').textContent = 'Installiert (oder in Arbeit)'; } deferredPrompt = null;
  });

  function makeIcon(size){
    const c = document.createElement('canvas'); c.width=size; c.height=size; const ctx=c.getContext('2d');
    const g = ctx.createLinearGradient(0,0,size,size); g.addColorStop(0,'#0a84ff'); g.addColorStop(1,'#065bd1'); ctx.fillStyle=g; ctx.fillRect(0,0,size,size);
    ctx.lineWidth=size*0.12; ctx.strokeStyle='#fff'; ctx.lineCap='round';
    ctx.beginPath(); ctx.moveTo(size*0.22,size*0.55); ctx.lineTo(size*0.38,size*0.71); ctx.lineTo(size*0.78,size*0.29); ctx.stroke();
    return c.toDataURL('image/png');
  }
  (function buildManifest(){
    const icons = [192,512].map(sz => ({ src: makeIcon(sz), sizes: sz+'x'+sz, type:'image/png', purpose:'maskable any' }));
    const manifest = { name: 'ReturnGuard', short_name: 'ReturnGuard', description: 'R√ºckgabefristen & Garantien im Griff ‚Äì offline, privat, ohne Konto.', start_url: './', display: 'standalone', background_color: '#0b0c0f', theme_color: '#0a84ff', icons };
    const blob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
    const url = URL.createObjectURL(blob); manifestLink.href = url;
  })();

  const secureContextOk = (location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1');
  const swStatus = document.getElementById('sw_status'), notifStatus = document.getElementById('notif_status'), bgStatus = document.getElementById('bg_status');
  document.getElementById('btn_install').disabled = true;

  async function registerSW(){
    if (!('serviceWorker' in navigator)){ swStatus.textContent = 'Service Worker: nicht unterst√ºtzt'; return; }
    if (!secureContextOk){ swStatus.innerHTML = 'Service Worker: <span class="warn-txt">kein HTTPS/localhost</span>'; return; }
    try{
      const iconDataUrl = makeIcon(192);
      const swCode = buildSWCode(iconDataUrl);
      const blob = new Blob([swCode], {type:'text/javascript'});
      const swUrl = URL.createObjectURL(blob);
      const reg = await navigator.serviceWorker.register(swUrl, { scope: './' });
      swStatus.textContent = 'Service Worker: registriert';
      navigator.serviceWorker.ready.then(async (r) => {
        if ('periodicSync' in r){
          try{ await r.periodicSync.register('returnguard-due-check', { minInterval: 6*60*60*1000 }); bgStatus.textContent = 'Background Sync: periodic'; }
          catch(e){ bgStatus.textContent = 'Background Sync: eingeschr√§nkt'; }
        } else if ('sync' in r){
          bgStatus.textContent = 'Background Sync: one-off';
          try{ await r.sync.register('returnguard-sync'); } catch {}
        } else { bgStatus.textContent = 'Background Sync: nicht verf√ºgbar'; }
        try{ await kvPut('state', state); }catch{}
        if (navigator.serviceWorker.controller){ navigator.serviceWorker.controller.postMessage({type:'CHECK_NOW'}); }
      });
    }catch(e){
      swStatus.innerHTML = 'Service Worker: <span class="err">'+e.message+'</span>';
    }
  }

  function buildSWCode(iconDataUrl){
    return `
    const VERSION = 'v1.0';
    const CACHE = 'returnguard-cache-' + VERSION;
    const DB_NAME = 'returnguard_data';
    const DB_VER = 5;
    const ICON = ${JSON.stringify(iconDataUrl)};
    self.addEventListener('install', (e) => { self.skipWaiting(); e.waitUntil(caches.open(CACHE)); });
    self.addEventListener('activate', (e) => { e.waitUntil((async () => {
      const keys = await caches.keys();
      await Promise.all(keys.filter(k => k.startsWith('returnguard-cache-') && k !== CACHE).map(k => caches.delete(k)));
      await self.clients.claim();
    })()); });
    self.addEventListener('fetch', (e) => {
      const url = new URL(e.request.url);
      if (e.request.method !== 'GET' || url.origin !== location.origin) return;
      e.respondWith((async () => {
        const cached = await caches.match(e.request);
        try {
          const resp = await fetch(e.request);
          const cache = await caches.open(CACHE);
          cache.put(e.request, resp.clone());
          return resp;
        } catch {
          if (cached) return cached;
          throw new Error('Offline und nicht im Cache.');
        }
      })());
    });

    function idb(){ return new Promise((res, rej) => {
      const req = indexedDB.open(DB_NAME, DB_VER);
      req.onupgradeneeded = (e) => {
        const d = e.target.result;
        if (!d.objectStoreNames.contains('kv')) d.createObjectStore('kv', { keyPath:'key' });
        if (!d.objectStoreNames.contains('files')) d.createObjectStore('files', { keyPath:'id' });
      };
      req.onsuccess = (e) => res(e.target.result);
      req.onerror = (e) => rej(e.target.error);
    }); }
    async function kvGet(key){ const d = await idb(); return await new Promise((res, rej) => { const tx = d.transaction('kv','readonly'); const os = tx.objectStore('kv'); const r = os.get(key); r.onsuccess = () => res(r.result ? r.result.value : null); r.onerror = () => rej(r.error); }); }
    async function kvPut(key, value){ const d = await idb(); return await new Promise((res, rej) => { const tx = d.transaction('kv','readwrite'); const os = tx.objectStore('kv'); const r = os.put({key, value, updatedAt: new Date().toISOString()}); r.onsuccess = () => res(); r.onerror = () => rej(r.error); }); }

    function pad(n){ return String(n).padStart(2,'0'); }
    function todayISO(){ const d = new Date(); return d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate()); }
    function mkDate(iso){ return new Date(iso + 'T12:00:00'); }
    function addDays(iso, days){ const d = mkDate(iso); d.setDate(d.getDate() + (days||0)); return d.toISOString().slice(0,10); }
    function daysBetween(aISO, bISO){ const a = mkDate(aISO); const b = mkDate(bISO); return Math.round((b - a) / 86400000); }

    function pruneNotified(map){
      const out = {}; const now = todayISO();
      for (const k in map){ const parts = k.split(':'); const due = parts[1]; if (!due) continue; const d = daysBetween(due, now); if (d <= 14) out[k] = true; } // keep only last 14 days
      return out;
    }

    async function checkDueAndNotify(force){
      const state = await kvGet('state');
      if (!state || !Array.isArray(state.items)) return;
      const now = todayISO();
      let notified = (await kvGet('notified')) || {};
      let changed = false;
      for (const it of state.items){
        if (it.archived) continue;
        if (!it.returnDays) continue;
        const due = addDays(it.date, it.returnDays);
        const days = daysBetween(now, due);
        if (days < 0) continue;
        if (days > 3 && !force) continue;
        const key = it.id + ':' + due;
        if (notified[key] && !force) continue;
        const title = (days===0 ? 'Heute letzter R√ºckgabetag' : days===1 ? 'Morgen letzter R√ºckgabetag' : 'R√ºckgabe in '+days+' Tagen');
        const body = it.name + (it.store ? ' ‚Ä¢ ' + it.store : '');
        await self.registration.showNotification(title, { body, tag: key, icon: ICON, badge: ICON, data: { itemId: it.id, due } });
        notified[key] = true; changed = true;
      }
      if (changed){ await kvPut('notified', pruneNotified(notified)); }
    }

    self.addEventListener('periodicsync', (e) => { if (e.tag === 'returnguard-due-check'){ e.waitUntil(checkDueAndNotify()); } });
    self.addEventListener('sync', (e) => { if (e.tag === 'returnguard-sync'){ e.waitUntil(checkDueAndNotify()); } });
    self.addEventListener('message', (e) => { if (!e.data) return; if (e.data.type === 'CHECK_NOW'){ e.waitUntil(checkDueAndNotify(true)); } if (e.data.type === 'STATE_MIRROR'){ /* noop */ } });
    self.addEventListener('notificationclick', (e) => {
      e.notification.close();
      e.waitUntil((async () => {
        const all = await self.clients.matchAll({ type:'window', includeUncontrolled:true });
        if (all && all.length){ all[0].focus(); all[0].postMessage({ type:'FOCUS_ITEM', itemId: e.notification.data && e.notification.data.itemId }); }
      })());
    });
    `;
  }

  const btnNotify = document.getElementById('btn_notify'); const btnTestNotif = document.getElementById('btn_test_notif');
  btnNotify.addEventListener('click', async () => {
    if (!secureContextOk){ alert('Aktiviere HTTPS oder starte √ºber http://localhost, sonst keine Benachrichtigungen.'); return; }
    if (!('Notification' in window)){ notifStatus.textContent = 'Benachrichtigungen: nicht unterst√ºtzt'; return; }
    const perm = await Notification.requestPermission();
    if (perm !== 'granted'){ notifStatus.innerHTML = 'Benachrichtigungen: <span class="warn-txt">'+perm+'</span>'; return; }
    notifStatus.textContent = 'Benachrichtigungen: erlaubt';
    await registerSW();
    if (navigator.serviceWorker.controller){ navigator.serviceWorker.controller.postMessage({type:'CHECK_NOW'}); }
  });
  btnTestNotif.addEventListener('click', async () => {
    if (!('Notification' in window)) { alert('Notifications nicht unterst√ºtzt'); return; }
    if (Notification.permission !== 'granted'){ await btnNotify.click(); if (Notification.permission !== 'granted') return; }
    const now = todayISO();
    let notified = (await kvGet('notified')) || {};
    let updated = false;
    state.items.forEach(it => {
      if (it.archived || !it.returnDays) return;
      const due = addDays(it.date, it.returnDays);
      const days = daysBetween(now, due);
      if (days < 0 || days > 3) return;
      const key = it.id + ':' + due;
      if (notified[key]) return;
      try{ new Notification(days===0?'Heute letzter R√ºckgabetag':'R√ºckgabe in '+days+' Tagen', { body: it.name + (it.store ? ' ‚Ä¢ ' + it.store : ''), icon: makeIcon(192) }); }catch{}
      notified[key] = true; updated = true;
    });
    if (updated) await kvPut('notified', notified);
    if (navigator.serviceWorker && navigator.serviceWorker.controller){ navigator.serviceWorker.controller.postMessage({type:'CHECK_NOW'}); }
  });

  navigator.serviceWorker && navigator.serviceWorker.addEventListener('message', (e) => {
    if (e.data && e.data.type === 'FOCUS_ITEM'){
      const id = e.data.itemId;
      if (!id) return;
      const btn = document.querySelector('button[data-id="'+id+'"]');
      if (btn){ btn.scrollIntoView({behavior:'smooth', block:'center'}); btn.classList.add('warn'); setTimeout(() => btn.classList.remove('warn'), 1500); }
    }
  });

  // Light periodic check (uses same IDB 'notified' map)
  setInterval(async () => {
    if (!('Notification' in window)) return;
    if (Notification.permission !== 'granted') return;
    const now = todayISO();
    let notified = (await kvGet('notified')) || {};
    let updated = false;
    const s = await store.read();
    s.items.forEach(it => {
      if (it.archived || !it.returnDays) return;
      const due = addDays(it.date, it.returnDays);
      const days = daysBetween(now, due);
      if (days < 0 || days > 3) return;
      const key = it.id + ':' + due;
      if (notified[key]) return;
      try{ new Notification(days===0?'Heute letzter R√ºckgabetag':'R√ºckgabe in '+days+' Tagen', { body: it.name + (it.store ? ' ‚Ä¢ ' + it.store : ''), icon: makeIcon(192) }); }catch{}
      notified[key] = true; updated = true;
    });
    if (updated) await kvPut('notified', notified);
  }, 15*60*1000);

  (function initStatus(){
    document.getElementById('btn_install').disabled = true;
    if ('serviceWorker' in navigator){
      if (!secureContextOk){ swStatus.innerHTML = 'Service Worker: <span class="warn-txt">kein HTTPS/localhost</span>'; }
      else { swStatus.textContent = 'Service Worker: bereit'; registerSW(); }
    } else { swStatus.textContent = 'Service Worker: nicht unterst√ºtzt'; }
    if ('Notification' in window){ notifStatus.textContent = 'Benachrichtigungen: ' + Notification.permission; } else { notifStatus.textContent = 'Benachrichtigungen: nicht unterst√ºtzt'; }
    bgStatus.textContent = 'Background Sync: unbekannt';
  })();

  function downloadFile(name, content, mime){ const blob = content instanceof Blob ? content : new Blob([content], {type: mime || 'application/octet-stream'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = name; document.body.appendChild(a); a.click(); a.remove(); setTimeout(() => URL.revokeObjectURL(url), 1000); }
  async function pickFile(accept){ return new Promise(resolve => { const inp = document.createElement('input'); inp.type='file'; if (accept) inp.accept = accept; inp.onchange = () => resolve(inp.files && inp.files[0] ? inp.files[0] : null); inp.click(); }); }
  function escapeICS(s){ return String(s).replace(/[,;\\]/g, m => ({ ',':'\\,',';':'\\;','\\\\':'\\\\\\\\'}[m] || m)); }
})();

  // === Global error surface ===
  window.addEventListener('error', (e) => {
    try {
      const bar = document.createElement('div');
      bar.style.position = 'fixed'; bar.style.left='0'; bar.style.right='0'; bar.style.bottom='0';
      bar.style.background = '#3a171b'; bar.style.color='#ffb3ad'; bar.style.padding='8px 12px';
      bar.style.borderTop='1px solid #5a2a28'; bar.style.fontSize='12px'; bar.style.zIndex='9999';
      bar.textContent = 'JS-Fehler: ' + (e.error && e.error.message ? e.error.message : e.message);
      document.body.appendChild(bar); setTimeout(() => bar.remove(), 8000);
    } catch {}
  });

</script>

<script>
(() => {
  const btn = document.getElementById('rgv1-theme-toggle');
  if (!btn) return;

  const themes = ['system', 'light', 'dark'];
  const icons = { system: 'üåó', light: '‚òÄÔ∏è', dark: 'üåô' };
  const LS_KEY = 'returnguard_theme';

  let currentTheme = localStorage.getItem(LS_KEY) || 'system';

  function applyTheme(theme) {
    document.documentElement.classList.remove('theme-light', 'theme-dark');
    if (theme === 'light') {
      document.documentElement.classList.add('theme-light');
    } else if (theme === 'dark') {
      document.documentElement.classList.add('theme-dark');
    }
    btn.textContent = icons[theme] || 'üåó';
    btn.title = `Theme: ${theme.charAt(0).toUpperCase() + theme.slice(1)}`;
  }

  btn.addEventListener('click', () => {
    const currentIndex = themes.indexOf(currentTheme);
    const nextIndex = (currentIndex + 1) % themes.length;
    currentTheme = themes[nextIndex];
    localStorage.setItem(LS_KEY, currentTheme);
    applyTheme(currentTheme);
  });

  // Apply initial theme on load
  applyTheme(currentTheme);
})();
</script>

<script>
(() => {
  const main = document.querySelector('main');
  if (!main) return;

  let ticking = false;

  function onScroll() {
    if (!ticking) {
      window.requestAnimationFrame(() => {
        const scrollY = window.scrollY;
        if (window.innerWidth > 768) {
          main.style.transform = `translateY(${scrollY * 0.4}px)`;
        } else {
          main.style.transform = 'none';
        }
        ticking = false;
      });
      ticking = true;
    }
  }

  window.addEventListener('scroll', onScroll, { passive: true });
})();
</script>

</body>
</html>
