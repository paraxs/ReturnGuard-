# CE-Prompt: ReturnGuard v0.9 â€Stabilisierungâ€œ â€“ Engineering Brief

**Rolle (du):** Senior JS/PWA-Engineer. Entscheide, setze um, liefere. Keine SchÃ¶nrederei, keine Workarounds, keine halben Fixes.

**Kontext (Stand heute â€“ nur was bleibt):**

* PWA-Basis vorhanden (Manifest/Icons on-the-fly, SW-Registrierung, Background-Sync, Statusanzeige).
* IndexedDB ist die **einzige** Quelle der Wahrheit (`kv`, `files`, Helfer `kvGet/kvPut`).
* IDs Ã¼berwiegend via `crypto.randomUUID()` (Fallback existiert, soll weg).
* Exporte vorhanden: CSV (korrektes Quoting), mehrere ICS-Exporter.

**Blocker (mÃ¼ssen vor allen anderen Features raus):**

* **Doppelte Benachrichtigungs-Pfade** (Seite + Service Worker) â†’ doppelte Toasts/Drift.
* **Mehrfache â€Global error surfaceâ€œ Listener** â†’ Mehrfach-Banner/Noise.
* **ICS uneinheitlich** (`escapeICS` in unterschiedlichen Varianten, All-Day teils mit `Z` â†’ falsch).
* **CDN-AbhÃ¤ngigkeiten** fÃ¼r Kernlibs (First-Load offline bricht).

---

## Ziel (dieser Sprint v0.9)

Eine **stabile** App ohne doppelte Pfade, mit **einer** korrekten `escapeICS`, konsistenten **All-Day-ICS**, dedupliziertem Error-Banner und **Precache** der kritischen Assets. Output darf Single-File bleiben.

---

## Muss-Regeln (Guardrails)

* **Regex-No-Excuse:** *Niemals* `\]` in Zeichenklassen (auÃŸer bewusstes `]` + zusÃ¤tzliches unescaped `]`). FÃ¼r Escapes **sequenzielle `.replace()`**, keine Char-Classes.
* **IndexedDB only** (kein `localStorage` als Schattenstatus).
* **Notifications:** Nur **ein** Pfad â€“ im **SW**. Die Page sendet maximal `postMessage({type:'CHECK_NOW'})`.
* **UUID:** Pflicht `crypto.randomUUID()`; andernfalls **hart** fehlschlagen mit klarer User-Meldung.

---

## Aufgaben (umsetzen, genau so)

### 1) Benachrichtigungen konsolidieren (nur SW)

* **Entfernen**: jedes `setInterval(...)`/`new Notification(...)` in der Page.
* **Beibehalten**: SW-Routine `checkDueAndNotify`.
* **Trigger von der Page** nach Ã„nderungen:

  ```js
  if (navigator.serviceWorker?.controller) {
    navigator.serviceWorker.controller.postMessage({ type: 'CHECK_NOW' });
  }
  ```
* **Akzeptanz:** Keine doppelte Notification bei fÃ¤lligen Items. Page-Refresh Ã¤ndert nichts am ZÃ¤hlsystem.

### 2) `escapeICS` vereinheitlichen (eine Quelle der Wahrheit)

Ersetze **alle** Varianten durch diese **einzige** Funktion:

```js
function escapeICS(s){
  return String(s)
    .replace(/\\/g, "\\\\")
    .replace(/\r\n/g, "\\n")
    .replace(/\n/g, "\\n")
    .replace(/,/g, "\\,")
    .replace(/;/g, "\\;");
}
```

* **Akzeptanz:** ICS/CSV-Fuzz (20 Strings) â†’ 20/20 korrekt; keine Roh-Newlines, keine rohen `,`/`;`, Backslashes verdoppelt.

### 3) ICS All-Day vereinheitlichen (kein `Z`)

* **Immer** All-Day mit:

  ```
  DTSTART;VALUE=DATE:YYYYMMDD
  DTEND;VALUE=DATE:YYYYMMDD_PLUS_1
  ```
* **Nie** aus einem Datum `Z`-Timestamps generieren.
* **Akzeptanz:** Alle ICS-Exporter erzeugen All-Day ohne `Z`; Import in Kalendern zeigt **ganztÃ¤gig**, genau 1 Tag.

### 4) Error-Banner deduplizieren

* **Ein** globaler Listener, frÃ¼h registriert, mit Guard:

  ```js
  if (!window.__rgErrorBarBound) {
    window.__rgErrorBarBound = true;
    window.addEventListener('error', (e) => { /* show banner once */ });
    window.addEventListener('unhandledrejection', (e) => { /* show banner once */ });
  }
  ```
* **Entfernen/ZusammenfÃ¼hren** aller duplizierten â€Extracted from <script src>â€œ-BlÃ¶cke.
* **Akzeptanz:** Pro Fehler maximal **ein** Banner.

### 5) UUID-Policy schÃ¤rfen

* Beim Anlegen von Items/Files:

  ```js
  function newId(){
    if (crypto?.randomUUID) return crypto.randomUUID();
    alert("Dein Browser ist zu alt (kein crypto.randomUUID). Bitte aktualisieren.");
    throw new Error("UUID required");
  }
  ```
* **Akzeptanz:** Keine `Math.random()`-IDs mehr; auf alten Browsern klarer Fail-Fast.

### 6) SW-Install: Precache kritischer Assets

* Im `install`-Event:

  ```js
  const PRECACHE = 'rg-v0.9-static';
  self.addEventListener('install', (e) => {
    e.waitUntil((async () => {
      const cache = await caches.open(PRECACHE);
      await cache.addAll([
        './',                // Single-file HTML (oder self URL)
        // ggf. Blob/Worker URLs, Inline-Bundles als fallback routes
      ]);
    })());
  });
  ```
* `fetch`-Handler: serve from cache, fallback network; bei Update SW-`activate` Cache-Version bumpen.
* **Akzeptanz:** â€First run offlineâ€œ funktioniert nach der ersten erfolgreichen Lade-Session.

### 7) UI-Robustheit (Symptome weg, Ursache fix)

* Duplicate-Listener/Mehrfach-Definitionen entfernen, **nicht** nur Early-Binder als Pflaster.
* Buttons in Formularen: **`type="button"`** setzen, wenn kein Submit.

---

## Anti-Regression (automatisch, beim Start)

### A) Regex-Self-Test (nie hart crashen)

```js
(function(){
  const tests = [
    () => /\\/g,
    () => /\n/g,
    () => /[^a-z0-9_\-\.]+/gi,
    () => /^https?:\/\//
  ];
  try { tests.forEach(make => { if (!(make() instanceof RegExp)) throw new Error('no regex'); }); }
  catch(e){ console.warn('[RG] Regex init failed', e); showBanner('Regex-Init fehlgeschlagen: '+e.message); }
})();
```

### B) ICS/CSV-Fuzz-Suite (20 FÃ¤lle)

* Beispiele: `"A,B;C\\\n"`, `"emoji ğŸ˜…, semicolon; back\\slash"`, CRLF/LF-Mischung, leere/mehrzeilige Texte.
* Erwartung: Newlines â†’ `\\n`; `,`â†’`\\,`; `;`â†’`\\;`; `\`â†’`\\`.

---

## Deliverables (DoD â€“ Definition of Done)

* [ ] Alle doppelten Notification-Pfade entfernt; SW ist **einzige** Quelle.
* [ ] Eine `escapeICS`-Implementierung (oben), global im Einsatz.
* [ ] ICS-Exporter **nur** All-Day-Format ohne `Z`.
* [ ] Ein globaler Error-Listener; keine doppelten Banner.
* [ ] `crypto.randomUUID()` verpflichtend; Fail-Fast bei Fehlen.
* [ ] SW-Precache aktiv; First-Run-Offline getestet.
* [ ] Regex-Self-Test aktiv; ICS/CSV-Fuzz 20/20 grÃ¼n.
* [ ] Manuelle 30-Schritte-Klickprobe ohne Exceptions.

---

## Commit-Plan (kurz & knackig)

1. `feat(sw): move due checks exclusively to SW; remove page polling`
2. `fix(ics): unify escapeICS (sequential); remove class-based variants`
3. `fix(ics): enforce all-day DTSTART/DTEND; remove Z timestamps`
4. `fix(error): dedupe global error surface; add once-guard`
5. `feat(id): require crypto.randomUUID; fail-fast on legacy`
6. `feat(sw): add install precache + cache version bump`
7. `chore(regex): add startup self-test + banner`
8. `test(export): add ICS/CSV fuzz harness (20 cases)`
9. `refactor(ui): remove duplicate listeners; set type="button"`

---

## Akzeptanzkriterien (messbar)

* **0** doppelte Notifications; **0** `missing /` o. Ã¤. Regex-Fehler.
* ICS-Import in gÃ¤ngigen Kalendern: **All-Day korrekt** und ein Tag lang.
* First-Run-Offline nach Erststart **ok**.
* Fuzz-Suite 20/20, UI-Smoke (30 Klicks) fehlerfrei.

---

## Nicht-Ziele in v0.9 (bewusst verschoben)

* Neue OCR-Profile/Heuristiken, Bild-Kompression, i18n â€“ kommen **nach** Stabilisierung.

---

> **FÃ¼hre diese Aufgaben jetzt durch.** Liefere PRs strikt in der obigen Reihenfolge. Jede PR schlieÃŸt die zugehÃ¶rigen Akzeptanzkriterien ab.
